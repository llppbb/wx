<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>消费信息</title>
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="../common/css/common.css">
    <script src="../common/officialJs/jquery-1.8.2.min.js"></script>
    <script src="../common/officialJs/fontSize.js"></script>
    <script src="../common/customJs/URL.js"></script>
    <script src="../common/customJs/AJAX.js"></script>
    <script src="../common/customJs/toastDialog.js"></script>
</head>

<body>
    <div class="wrap">
        <div class="title flex_between">
            <div class="pointShow"><span id="canGetPoint">可获得</span><span id="point" style="color:#FD4969;fontSize:.18rem"> 0</span> 积分</div>
            <div class="pointStatus pointStatusOn" id="btn"></div>
        </div>
        <div class="center">
            <div class="name" id="merchantName"></div>
            <div class="centerMes flex_between">
                <div>消费金额</div>
                <div>￥<span id="amount">0</span></div>
            </div>
            <div class="centerMes flex_between">
                <div id="pointStatus">已领取积分</div>
                <div id="alreadyPoint">0</div>
            </div>
            <div class="centerMes centerDate">====== 消费日期 <span id="date"></span> ======</div>
        </div>
        <div class="imgShow">
            <img src="img/weixinicon.png" />
            <p>长按二维吗，进入公众号查看积分</p>
        </div>
        <div class="shezhi_tishi">
            <p></p>
        </div>
    </div>

    <div class="noData"></div>

    <script charset="utf-8" src="https://map.qq.com/api/js?v=2.exp"></script>
    <script charset="utf-8" src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script type="text/javascript" src="https://pingjs.qq.com/h5/stats.js" name="MTAH5" sid="500338441"></script>
    <script src="../common/customJs/wxShare.js"></script>
    <script type="text/javascript">
        var openId = getUrlParam("openid");
        var hasCard = getUrlParam("hasCard"); //1 有卡 0没卡
        var uid = getUrlParam("uid");
        var cityId = getUrlParam("cityId");
        var qrCode = getUrlParam("qrCode");
        if (openId !== "") {
            setStorage("gagQrCode", qrCode);
            var backStorage = getStorage("gagQrCode");
            var getPayInfoSendata = {
                "uid": uid,
                "qrCode": backStorage
            };
            getPayInfo(getPayInfoSendata);
        } else {
            // 无 openid
            window.location.href = WX_URL + "HXXCServiceWeChat/auth/oauth?qrCode=" + encodeURIComponent(qrCode);
        }

        $(".pointStatusOn").on("click", function() {
            if (hasCard == 1) {
                addShoppingPoint(uid, backStorage, 1);
            } else {
                window.location.href = "../memberCard/gagRegister.html?openId=" + openId + "&code=" + qrCode+ "&cityId=" + cityId;
            }
        })
        //获取信息
        function getPayInfo(sendData) {
            var sendUrl = WX_URL + "HXXCServiceWeChat/point/getPayInfo";
            fnAjax(sendUrl, "get", false, sendData, function(data) {
                if (data.state == 0) {
                    if (data.flag == 0) {
                        $("#canGetPoint").show();
                        $("#pointStatus").html("可领取积分");
                        $("#btn").addClass('pointStatusOn').removeClass('pointStatusOff');
                    } else {
                        $("#canGetPoint").hide();
                        $("#pointStatus").html("已领取积分");
                        $("#btn").addClass('pointStatusOff').removeClass('pointStatusOn');
                        $("#btn").html("已领取");
                    }
                    // if (data.isMySelf == 1) {
                    //     // 显示二维码
                    //     $(".imgShow").hide();
                    // } else {
                    //     // 不显示
                    //     $(".imgShow").show();
                    // }
                    $("#point").html(data.point);
                    $("#merchantName").html(data.merchantName);
                    $("#amount").html(data.amount);
                    $("#alreadyPoint").html(data.point);
                    var date = data.date;
                    var dateNew = date.slice(0, 4) + "-" + date.slice(4, 6) + "-" + date.slice(6, 8);
                    $("#date").html(dateNew);
                } else {
                    tishiNew("获取店铺或消费数据失败，请联系商家或管理员！");
                }
            }, function(error) {});
        }
        //立即领取  flag 0 未领取  1 领取过
        function addShoppingPoint(uid, backStorage, cityid) {
            var sendUrl = WX_URL + "HXXCServiceWeChat/point/addShoppingPoint";
            var getPayInfoSendata = {
                "uid": uid,
                "qrCode": backStorage,
                "cityId": cityid
            };
            fnAjax(sendUrl, "get", false, getPayInfoSendata, function(data) {
                if (data.state == 0) {
                    tishi("领取成功!");
                    $("#canGetPoint").hide();
                    $("#btn").addClass('pointStatusOff').removeClass('pointStatusOn');
                    $("#btn").html("已领取");
                    $("#pointStatus").html("已领取积分");
                    console.log("使用！");
                } else {
                    tishi("领取积分失败，请稍后再试！");
                }
            }, function(error) {});
        }

        function tishiNew(message) { //提示信息
            $('.shezhi_tishi p').html(message);
            $('.shezhi_tishi').show();
            var windowWidth = $(window).width();
            var tiShiBoxWidth = $(".shezhi_tishi").innerWidth();
            var leftMargin = (windowWidth - tiShiBoxWidth) / 2;
            $(".shezhi_tishi").css("left", leftMargin + "px");
            $('.shezhi_tishi').css('opacity', '0.7');
            setTimeout(function() {
                $('.shezhi_tishi').fadeOut(1000);
            }, 5000)
        }
    </script>
</body>

</html>
