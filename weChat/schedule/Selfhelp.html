<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="format-detection" content="telephone=no" />
    <meta name="format-detection" content="email=no" />
    <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" id="viewport" name="viewport">
    <title>选择</title>
    <link rel="stylesheet" href="css/choose_session_price_num.css">
    <style>
        .header {
            position: relative;
            padding-bottom: .15rem;
            border: none;
        }

        .productimg {
            position: absolute;
            left: .14rem;
            top: 0.2rem;
            width: .845rem;
            height: 1.18rem;
        }

        .headerright {
            padding: .2rem .14rem 0 1.125rem;
        }

        .time_name {
            font-size: .15rem;
            color: #ffffff !important;
            margin-bottom: .1rem;
        }

        .producttime {
            font-size: .12rem;
            color: #B3B3B3 !important;
            margin-bottom: .06rem;
        }

        html,
        body,
        .wrap {
            background: #ffffff !important;
        }

        .choose {
            margin-top: 0.2rem;
            color: #808080;
        }

        .choose_pricenew {
            margin-top: 0rem;
        }

        .choose_seesion_centen_jisuan {
            /* height: 0.85rem; */
            height: .33rem;
            border: 1px solid #E6E6E6;
            border-radius: .04rem;
            margin-left: .14rem;
            margin-right: .14rem;
        }

        .choose_seesion_jisuan {
            width: 0.35rem;
            height: 0.275rem;
            background: #E6E6E6;
            text-align: center;
            line-height: 0.275rem;
            border: none;
            float: right;
            font-size: 0.25rem;
            color: #989898;
            margin-top: 0.015rem;
        }

        .choose_seesion_centen {
            padding-left: 0.14rem;
            padding-right: 0.02rem;
        }

        .choose_seesion_number {
            border: none;
            color: #e9064e;
            background: #E6E6E6;
            margin-left: 0.02rem;
            margin-right: 0.02rem;
        }

        .productdanprice {
            float: left !important;
            line-height: .33rem;
            color: #989898;
        }

        .footerNext {
            background: none;
        }

        .footerNext div {
            float: left;
        }

        .footerNext div:first-child {
            width: 70%;
            font-size: .16rem;
            color: #808080;
            background: #FBFBFB;
            text-align: right !important;
            padding-right: .14rem;
        }

        .footerNext div:last-child {
            width: 30%;
            font-size: .16rem;
            color: #333333;
        }

        .header {
            width: 100%;
            margin-bottom: .1rem;
        }

        .headertop {
            background: url(../buyTicket/img/img_bg2.png) no-repeat;
            background-size: 100% 100%;
            padding: .2rem .19rem .13rem 1.125rem;
        }

        .header {
            position: relative;
        }

        .posterImage {
            position: absolute;
            left: .14rem;
            width: .845rem !important;
            height: 1.18rem !important;
            top: 0.2rem;
        }

        .h4 {
            font-size: .18rem;
            color: #ffffff;
            height: .45rem;
        }

        .pp12 {
            font-size: .12rem !important;
            color: #b3b3b3 !important;
            line-height: .1rem
        }

        .choose_seesion_centen {
            clear: both;
        }

        .choose {
            clear: both;
        }

        .choose_seesion_price {
            height: .35rem;
        }

        #footerNext {
            background: #ffdd10;
        }

        .weidenglu_tishi {
            position: absolute;
        }

        .choose_seesion_price {
            /*ui要求*/
            width: 1.11rem;
            /*padding: 0px;*/
            margin-right: .07rem;
        }

        .quehuodengjinew {
            position: absolute;
            right: -3px;
            bottom: -2px;
            font-size: 0.1rem;
            color: #ed3771;
            background: rgb(230, 230, 230);
            padding: 0 .01rem;
            -webkit-transform: scale(0.8, 0.8);
        }

        .choose_seesion_NOprice {
            padding-top: 0.085rem;
        }
        /*点不了  */

        .color_fb {
            background: #fbfbfb;
            color: #d8d8d8;
        }
        /* 能点 */

        .color_f5 {
            background: #f5f5f5 !important;
            color: #989898 !important;
        }

        .choose_seesion_jisuan {
            background: #f5f5f5;
            color: #989898;
        }

        .shezhi_tishinew {
            border-radius: 0.04rem;
            background: #000000;
            opacity: 0.6;
            position: fixed;
            left: 36%;
            top: 30%;
            padding: 0 0.1rem;
            color: #FFFFFF;
            text-align: center;
            line-height: 0.32rem;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <header class="header">
            <img id="posterImage" src="" class="posterImage" style="box-shadow: 1px 1px 5px rgba(0,0,0,.4);" />
            <div class="headertop">
                <h4 class="h4" id="showTitle2"></h4>
                <p class="pp12" style="margin-top:.1rem;margin-bottom:.06rem;" id="showDate"></p>
                <p class="pp12" id="showTime2"></p>
            </div>
        </header>
        <div class="choose choose_seesion">
            <p class="choose_title">选择场次</p>
            <div class="choose_seesion_centen choose_seesion_price_box" id="choose_seesion_box">

            </div>
        </div>
        <div class="choose choose_price choose_pricenew" id="choose_price_box">
            <p class="choose_title">选择票价</p>

        </div>
        <div class="choose choose_num">
            <p class="choose_title">选择张数<span class="choose_num_span">同一账号同一场次一次限购<span id="buyLimit">2</span>张</span>
            </p>
            <div class="choose_seesion_centen choose_seesion_centen_jisuan">
                <div class="productdanprice" id="unitPrice"> </div>
                <div class="choose_seesion_jisuan choose_seesion_add" id="addBtn">﹢</div>
                <div class="choose_seesion_jisuan choose_seesion_number">1</div>
                <div class="choose_seesion_jisuan choose_seesion_jian" id="removeBtn">
                    <p>﹣</p>
                </div>
            </div>
        </div>
        <div class="footerNext">
            <div>
                <P>总价 <span id="price">0</span><span>元</span></P>
            </div>
            <div id="footerNext" click="true">下一步</div>
        </div>
    </div>
    <div class="mengceng"></div>

    <div class="weidenglu_tishi" id="nomobile">
        <div class="weidenglu_tishi_title">
            <p class="weidenglu_tishi_title_p1">缺货登记</p>
        </div>
        <div class="yangzhengChange">
            <div class="shoujihao">
                <input type="number" placeholder="请输入手机号" id="shoujihao" class="numberShoujihao" value="<?php echo $mobile ?>" />
                <input type="button" class="getyzm" value="获取验证码" />
            </div>
            <div class="yanzhengma">
                <input type="number" placeholder="4位验证码" id="yanzhengmaBtn" class="yazhengmaIput" />
            </div>
        </div>
        <div class="weidenglu_tishi_title">
            <p class="weidenglu_tishi_title_p2">本售价已售罄，点击确定按钮，我们将在有票时第一时间将短信通知发送给您的手机</p>
        </div>
        <div class="weidenglu_tishi_bottom">
            <div class="quexiaoBtn">取消</div>
            <div class="quedingBtn">确定</div>
        </div>
    </div>
    <div class="shezhi_tishi" style="display: none">
        <P>设置成功</P>
    </div>
    <div class="shezhi_tishinew" style="display: none">
        <P>设置成功</P>
    </div>
    <!--有未支付订单提示-->
    <div class="yidenglu_tihsi weizhifudingdan_tihsi" style="display: none;">
        <div class="yidenglu_tihsi_title">
            <p class="yidenglu_tihsi_title_p2 weizhifudingdan_tihsi_title_p2">
                <!-- <span id="buyLimit_tihsi">该场次限购x张，</span> -->
                检测到您还有未支付订单，故无法重复购买，您可以继续支付或取消订单
            </p>
        </div>
        <div class="yidenglu_tihsi_bottom">
            <div class="quexiaoBtn">关闭</div>
            <div id="ViewUnpaidOrders">查看未支付订单</div>
        </div>
    </div>
    <script src="../common/officialJs/jquery-1.8.2.min.js"></script>
    <script src="../common/officialJs/fontSize.js"></script>
    <script src="../common/customJs/URL.js"></script>
    <script src="../common/customJs/AJAX.js"></script>
    <script src="../common/customJs/common.js"></script>
    <script src="../common/customJs/toastDialog.js"></script>
    <script src="../common/customJs/bindMobile.js"></script>
    <script src="js/Judge_state.js"></script>
    <script src="../buyTicket/js/AJAXFuntion.js"></script>
    <!-- <script src="weixin/common/common.js"></script> -->
    <script type="text/javascript" src="https://pingjs.qq.com/h5/stats.js" name="MTAH5" sid="500338441"></script>
    <script>
        window.onpageshow = function(event) {
            if (event.persisted) {
                window.location.reload();
            }
        };
        if (!getStorage("userData")) {
            window.location.href = WX_URL + "HXXCServiceWeChat/wechat/wechat_verify";
        } else {
            var userData = getStorage("userData");
        }
        var uid = userData.uid;
        var mobile = userData.mobile;
        var onlineID = getUrlParam("onlineID");
        var tishiBox = '';
        // 获取详情信息
        getProgramDetail(onlineID);
        // 获取价格票价详细信息
        var returnDataProgramInfoAjax = programInfoAjax(onlineID);
        // 渲染页面结构 场次票价
        schedulePriceInfo(returnDataProgramInfoAjax);

        window.onload = function() {
            // var classNeme = $('.choose_seesion_time');
            // Judge_state(classNeme);
            $('.choose_seesion_time:first').addClass('choose_seesion_time_on');
            $('.choose_seesion_price:first').addClass('choose_seesion_price_on');
            $('.pricearea:first').show();
            var price = $(".choose_seesion_price_on").attr('price');
            var ticketNum = $(".choose_seesion_number").html();
            var total = (ticketNum * price).toFixed(2);
            $("#price").html(total);
            var buyLimit = $(".choose_seesion_time_on").attr('buyLimit');
            if (buyLimit != 0) {
                $("#buyLimit").html(buyLimit);
            } else {
                $(".choose_num_span").hide();
            }
            $("#unitPrice").html("单价" + $(".choose_seesion_price_on").find("span").html());
        }
        var quehuo = '<p class="quehuodengjinew">缺货登记</p>';
        $(".choose_seesion_NOprice").append(quehuo);
        $("#removeBtn").on("click", function() {
            var buyLimit = $(".choose_seesion_time_on").attr('buyLimit');
            var value = $(".choose_seesion_number").html();
            var newvalue = --value;
            if (newvalue < buyLimit && newvalue > 1) {
                $("#addBtn").addClass('color_f5').removeClass('color_fb');
            } else if (newvalue <= 1) {
                console.log("333")
                newvalue = 1;
                $("#removeBtn").find("p").addClass('color_fb').removeClass('color_f5');
                $("#addBtn").addClass('color_f5').removeClass('color_fb');
                // $(".choose_seesion_jian p").css({
                //     'color': '#E6E6E6'
                // });
                // $(".choose_seesion_border").css({
                //     'border': '1px solid #E6E6E6'
                // });
                // $("#addBtn").css({
                //     'color': '#333333',
                //     'border': '1px solid #333333'
                // });
            }
            $(".choose_seesion_number").html(newvalue);
            var price = $(".choose_seesion_price_on").attr('price');
            var ticketNum = $(".choose_seesion_number").html();
            var total = (ticketNum * price).toFixed(2);
            $("#price").html(total);
        });

        $("#addBtn").on("click", function() {
            // 点不了 background： fbfbfb； color:d8d8d8 ; 能点 f5f5f5 color:989898
            var buyLimit = $(".choose_seesion_time_on").attr('buyLimit');
            console.log(buyLimit)
            var price = $(".choose_seesion_price_on").attr('price');
            var ticketCount = $(".choose_seesion_price_on").attr('ticketCount');
            var value = $(".choose_seesion_number").html();
            if (price == undefined) {
                tishi('请选择价格');
                return false;
            }
            var newvalue = ++value;
            if (buyLimit != 0) {
                if (newvalue > 1) {
                    $("#removeBtn").find("p").addClass('color_f5').removeClass('color_fb');
                    if (newvalue == ticketCount) {
                        $("#addBtn").addClass('color_fb').removeClass('color_f5');
                    } else if (newvalue > ticketCount) {
                        $("#addBtn").addClass('color_fb').removeClass('color_f5');
                        tishi('余票不足！');
                        return false;
                    } else if (newvalue == buyLimit) {
                        $("#addBtn").addClass('color_fb').removeClass('color_f5');
                    } else if (newvalue > buyLimit) {
                        $("#addBtn").addClass('color_fb').removeClass('color_f5');
                        tishi('该场次限购' + buyLimit + '张票！');
                        return false;
                    }
                }
                
            } else {
                if (newvalue > 1) {
                    $("#removeBtn").find("p").addClass('color_f5').removeClass('color_fb');
                    if (newvalue == ticketCount) {
                        $("#addBtn").addClass('color_fb').removeClass('color_f5');
                    } else if (newvalue > ticketCount) {
                        $("#addBtn").addClass('color_fb').removeClass('color_f5');
                        tishi('余票不足！');
                        return false;
                    }
                }
            }
            $(".choose_seesion_number").html(newvalue);
            var ticketNum = $(".choose_seesion_number").html();
            var total = (ticketNum * price).toFixed(2);
            $("#price").html(total);
            return false;
        });

        $(".choose_seesion_time").click(function(event) {
            var scheduleid = $(this).attr('scheduleid');
            var buyLimit = $(this).attr('buyLimit'); //
            if (buyLimit != 0) {
                $(".choose_num_span").show();
            } else {
                $(".choose_num_span").hide();
            }
            $("#buyLimit").html(buyLimit); //
            $(this).addClass('choose_seesion_time_on').siblings().removeClass('choose_seesion_time_on');
            $(".choose_seesion_price").removeClass('choose_seesion_price_on');
            $(".choose_seesion_number").html(1);
            $("#price").html(0);
            $('.pricearea').hide();
            $('#sp_' + scheduleid).show();
            $("#unitPrice").html($("this").find("span").html());
            $('#sp_' + scheduleid).find('.choose_seesion_price:first').addClass('choose_seesion_price_on'); //
            var price = $(".choose_seesion_price_on").attr('price');
            var ticketNum = $(".choose_seesion_number").html();
            var total = (ticketNum * price).toFixed(2);
            $("#price").html(total);
        });
        $(".choose_seesion_price").click(function(event) {
            $(".choose_seesion_price").removeClass('choose_seesion_price_on');
            $(this).addClass('choose_seesion_price_on');
            $("#unitPrice").html("单价" + $(".choose_seesion_price_on").find('span').html());
            $(".choose_seesion_number").html(1);
            var price = $(".choose_seesion_price_on").attr('price');
            var ticketNum = $(".choose_seesion_number").html();
            var total = (ticketNum * price).toFixed(2);
            $("#price").html(total);
        });
        $(".choose_seesion_NOprice").click(function(event) { //缺货提示
            $(".mengceng").show();
            $("#yanzhengmaBtn").val("");
            tishiBox = $("#nomobile");
            tishiBox.show();
        });
        $(".quexiaoBtn").click(function(event) {
            tishiBox.hide();
            $(".mengceng").hide();
            return;
        });
        $("#ViewUnpaidOrders").click(function(event) {
            tishiBox.hide();
            location.href ="../ticketFolder/ticketStart.html";
            return;
        });
        $(".quedingBtn").click(function(event) {
            var scheduleId = $(".choose_seesion_time_on").attr("scheduleid");
            var ticketPriceId = $(".choose_seesion_price_on").attr('ticketPriceId');
            var packTicketId = $(".choose_seesion_price_on").attr('packTicketId') ? $(".choose_seesion_price_on").attr('packTicketId') : '';
            var smCode = $("#yanzhengmaBtn").val();
            var smMobile = $("#shoujihao").val();
            if (!checkMobileAndSMSCode(smMobile, smCode)) {
                return false;
            }
            $(".mengceng").hide();
            ShortageRegistration(uid, smMobile, onlineID, scheduleId, ticketPriceId, packTicketId, tishiBox);
        });
        // 1.获取验证码
        $(".getyzm").click(function(event) {
            var mobile = $("#shoujihao").val();
            var obj = $(".getyzm");
            getyzm(mobile, obj);
        });
        $("#footerNext").click(function(event) {
            if ($(this).attr("click") == "true") {
                $(".footerNext").css("background", "none");
                $("#footerNext").attr("click", "false");
                $("#footerNext").css("background", "gray");
                var scheduleid = $(".choose_seesion_time_on").attr('scheduleid');
                var ticketPriceId = $(".choose_seesion_price_on").attr('ticketPriceId');
                var packTicketId = $(".choose_seesion_price_on").attr('packTicketId') ? $(".choose_seesion_price_on").attr('packTicketId') : '';
                var ticketNum = $(".choose_seesion_number").html();
                if (scheduleid == undefined || ticketPriceId == undefined || $(".choose_seesion_price_on").hasClass('choose_seesion_NOprice')) {
                    tishi("请选择场次或价格！");
                    $("#footerNext").css("background", "#ffdd10");
                    $("#footerNext").attr("click", "true");
                    return false;
                }
                var data = {
                    "uid": uid,
                    "onlineID": onlineID,
                    "scheduleId": scheduleid,
                    "ticketPriceId": ticketPriceId,
                    'packTicketId': packTicketId,
                    "ticketNum": ticketNum,
                    "seats":null
                }
                var returnLockSeatAjax = lockSeatAjax(data);
                if (!returnLockSeatAjax) {
                    console.log("请求lockSeatAjax失败");
                } else {
                    if (parseInt(returnLockSeatAjax.state) == 1) {
                        $("#footerNext").css("background", "#ffdd10");
                        $("#footerNext").attr("click", "true");
                        if (returnLockSeatAjax.message.indexOf('未支付') != -1) {
                            tishiBox = $('.weizhifudingdan_tihsi');
                            $(".mengceng").show();
                            var buyLimit = $(".choose_seesion_time_on").attr('buyLimit');
                            tishiBox.show();
                        } else {
                            tishinew(returnLockSeatAjax.message);
                        }
                        return;
                    } else if (data == -1) {
                        tishi("订单创建失败，请重新操作！");
                        $("#footerNext").css("background", "#ffdd10");
                        $("#footerNext").attr("click", "true");
                        return;
                    } else {
                        $("#footerNext").css("background", "#ffdd10");
                        $("#footerNext").attr("click", "true");
                        location.href = "pay.html?orderNo=" + returnLockSeatAjax.result.orderNo + "&programId=" + onlineID;
                    }
                }
            }
        });

        // 获取 项目
        function getProgramDetail(programId) {
            var data = {
                "id": parseInt(programId)
            }
            var returnDetailAjax = detailAjax(data);
            if (!returnDetailAjax) {
                console.log("请求detailAjax失败");
            } else {
                if (parseInt(returnDetailAjax.state) == 0) {
                    $("#posterImage").attr("src", returnDetailAjax.result.posterImage);
                    $("#showTitle2").html(returnDetailAjax.result.showTitle2);
                    $("#showDate").html(returnDetailAjax.result.showDate);
                    if (returnDetailAjax.result.showTime2 != '') {
                        $("#showTime2").html("时长：" + data.result.showTime2 + " 分钟");
                    }
                }
            }
        }

        //渲染 价格结构
        // function schedulePriceInfo(data) {
        //     if (!data) {
        //         console.log("programInfo 出错");
        //     }else{
        //         var dataReturn = data;
        //         var choose_seesion_boxHTML = "";
        //         var choose_price_box = "";
        //         console.log(dataReturn.schedule)
        //         $.each(dataReturn.schedule, function(i, k) {
        //             choose_seesion_boxHTML += '<div class="choose_seesion_time" scheduleid="' + k.id + '" buyLimit="' + k.scheduleNumber + '">' + k.playTime + '</div>';
        //             var ticketPrice = "";
        //             var packTickets = "";
        //             $.each(k.ticketPrice, function(j, p) {
        //                 var classNameState = (p.status == 3 || k.ticketCount == 0) ? 'choose_seesion_NOprice' : '';
        //                 var description = (p.description==null)  ? '' : p.description;
        //                 ticketPrice += '<div class="choose_seesion_price ' + classNameState + '" ticketPriceId="' + p.id + '" price="' + p.price + '" ticketCount="' + p.ticketCount + '">' +
        //                     '<span>' + p.price + '元</span>' + description + '</div>';
        //             });
        //
        //             $.each(k.packTickets, function(q, w) {
        //                 var classNameState = (w.status == 3 || w.ticketCount == 0) ? 'choose_seesion_NOprice' : '';
        //                 var description =  (w.description==null) ? '' : w.description;
        //                 packTickets += '<div class="choose_seesion_price ' + classNameState + '" packTicketId="' + w.id + '" ticketPriceId="' + w.ticketPriceId + '" price="' + packAmount + '" ticketCount="' + ticketCount + '">' +
        //                     name + '</div>';
        //             });
        //             choose_price_box += '<div class="choose_seesion_centen pricearea choose_seesion_price_box choose_seesion_price_boxnew" id="' + k.id + '">'
        //             +ticketPrice+'' + packTickets +'</div>'
        //         });
        //         $("#choose_seesion_box").html(choose_seesion_boxHTML);
        //         $("#choose_price_box").append(choose_price_box);
        //     }
        //
        // }

        // 禁用微信分享
        function onBridgeReady() {
            WeixinJSBridge.call('hideOptionMenu');
        }

        if (typeof WeixinJSBridge == "undefined") {
            if (document.addEventListener) {
                document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
            } else if (document.attachEvent) {
                document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
                document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
            }
        } else {
            onBridgeReady();
        }
    </script>
</body>

</html>
