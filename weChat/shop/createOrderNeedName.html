<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="format-detection" content="telephone=no" />
    <meta name="format-detection" content="email=no" />
    <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" id="viewport" name="viewport">
    <title>提交订单</title>
    <link rel="stylesheet" href="css/tijiaoCBA.css">
    <link rel="stylesheet" href="css/common.css">
</head>

<body <div class="wrap">
    <!-- <div class="shengyuTime">
                <p class="font_14_color_51">支付剩余时间：<span class="font_14_color_233" id="showData">09分59秒</span></p>
            </div> -->
    <div class="project_name">
        <p id="product_name"></p>
    </div>
    <div class="project_number">
        <p>数量</p>
        <div class="choose_seesion_centen choose_seesion_centen_jisuan">
            <div class="choose_seesion_jisuan choose_seesion_jian" id="jianBtn">
                <p>﹣</p>
            </div>
            <div class="choose_seesion_jisuan choose_seesion_number" id="Value">1</div>
            <div class="choose_seesion_jisuan choose_seesion_add" id="addBtn">﹢</div>
        </div>
        <div class="project_number_Num">本场次总共限购<span id="eachangmaxnumber">4</span>张</div>
        <div class="project_number_money"><span id="cbachangstate">花费金额：</span><span id="cbaMoney">￥50</span></div>
    </div>

    <div class="realename" style="display:none">
        <p class="realename_title">实名信息</p>
        <div class="realename_center">
            <div class="realename_center_mes">
                <p class="yollow">本场比赛为实名制项目，需另凭身份证检票入场</p>
                <p>已选<span class="yollow selectedNum">1</span>张，需至少提交<span class="yollow selectedNum">1</span>个不同的实名信息</p>
            </div>
            <div class="realename_center_namebox">
                <div class="realename_center_list">
                    <div class="list_num">
                        <p>1</p>
                    </div>
                    <div class="list_nameID">
                        <div class="list_name" change=0>
                            <p>真实姓名：</p>
                            <input type="text" placeholder="请填写身份证上的姓名" class="input_empty list_name_input" onfocus="inputFocus(this)" onkeyup="inputKeyup(this)">
                            <div class="empty" onclick="empty_(this)"><img src="pic/icon_closecard.png"/></div>
                        </div>
                        <div class="list_ID">
                            <p>身份证号：</p>
                            <input type="text" placeholder="请填写正确的身份证号码" class="input_empty list_id_input" onfocus="inputFocus(this)" onkeyup="inputKeyup(this)">
                            <div class="empty" onclick="empty_(this)"><img src="pic/icon_closecard.png"/></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- <div class="zhifuFangshi">
            <div class="fangshimiaoshu fangshimiaoshu_weixin">
                <p class="wutubiao_fangshimiaoshu">花费积分</p>
                <div class="tishi_tupain wutubiao_number" id="product_price">0</div>
            </div>
        </div> -->

    <!--添加收货地址-->
    <div class="tianjiashouhuodizhi" id="add_address_btn" style="display:none">
        <img src="pic/icon_add.png" class="icon_add" />
        <p class="font_15_color_51">请添加收货地址</p>
        <img src="pic/gengduo.png" class="jianhao" />
    </div>
    <!--收货地址列表-->
    <div class="dizhi_liebiao" style="display:none">
        <div class="xingmingshoujihao">
            <p class="font_15_color_51 xingmingshoujihao_p1" id="name"></p>
            <p class="font_15_color_51 xingmingshoujihao_p2" id="mobile"></p>
        </div>
        <div class="xiangxidizhi">
            <p class="font_14_color_128" id="address"></p>
        </div>
        <div class="jianhao" id="change_address">
            <img src="pic/gengduo.png" />
        </div>
    </div>

    <!--<div class="zhifuFangshi">
                <div class="fangshimiaoshu">支付方式</div>
                <div class="fangshimiaoshu fangshimiaoshu_weixin">
                    <div class="weixin_tupian"><img src="pic/icon_selected_wx.png" /></div>
                    <p>微信</p>
                    <div class="tishi_tupain"><img src="pic/Group.png" /></div>
                </div>
            </div>-->
    <div class="paymes" style="display:none">提交订单后请在<span>2</span>分钟内进行支付</div>
    <div class="footerHeji">
        <div class="zhifuBtn" id="queding_btn">确定</div>
    </div>

    </div>

    <div class="guoqi_tishi" style="display: none;">该订单已过期<br/>请重新下单</div>
    <!--支付失败 微信 支付宝  提示-->
    <div class="mengceng" style="display: none;"></div>
    <div class="weidenglu_tishi zhifushibai" style="display: none;">
        <div class="weidenglu_tishi_title">
            <p class="weidenglu_tishi_title_p2">支付失败！订单会为您保留10分钟，请您尽快支付</p>
        </div>
        <div class="weidenglu_tishi_bottom">
            <div class="i_know">我知道了</div>
        </div>
    </div>

    <script src="../common/officialJs/jquery-1.8.2.min.js"></script>
    <script src="../common/officialJs/fontSize.js"></script>
    <script src="../common/officialJs/md5.js"></script>
    <!-- <script src="../common/common.js"></script> -->
    <script src="../common/customJs/URL.js"></script>
    <script src="../common/customJs/AJAX.js"></script>
    <script src="js/shopCommon.js"></script>
    <script src="js/common.js"></script>
    <script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script type="text/javascript" src="https://pingjs.qq.com/h5/stats.js" name="MTAH5" sid="500338441"></script>
    <script>
        function deleteEle(arr) {  
            var newArr = arr;  
            for (var i = newArr.length - 1; i >= 0; i--)   {    
                var targetNode = newArr[i];    
                for (var j = 0; j < i; j++)     {      
                    if (targetNode == newArr[j]) {
                        console.log("有重复")
                        //         newArr.splice(i,1);
                                newArr = "repeat";        
                        break;      
                    }    
                }  
            }  
            return newArr;
        }

        var list_nameID_height = $(".list_nameID").height();
        $(".list_num").css("height", list_nameID_height + "px");

        function inputFocus(obj) {
            $(".empty").hide();
            var length = $(obj).val().trim().length;
            if (length > 0) {
                $(obj).next().show();
            }
        }

        function inputKeyup(obj) {
            var length = $(obj).val().trim().length;
            if (length > 0) {
                $(obj).next().show();
            } else {
                $(obj).next().hide();
            }
        }
        //   实名制 清空 内容
        function empty_(obj) {
            $(obj).prev().val("");
            $(obj).hide();
        }

        function funblur(obj) {
            var idCard = obj.trim();
            // console.log(typeof(idCard))
            if (idCard.length == 15) {
                isIDCard1 = /^[1-9]\d{7}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}$/;
                var  reg = new RegExp(isIDCard1);
                if (!reg.test(idCard)) {
                    return false;
                }
            } else if (idCard.length == 18) {
                isIDCard2 = /^[1-9]\d{5}[1-9]\d{3}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}([0-9]|X)$/;
                var  reg = new RegExp(isIDCard2);
                if (!reg.test(idCard)) {
                    return false;
                }
            } else {
                return false;
            }
            return true;
        }

        if (!getStorage("userData")) {
            window.location.href = WX_URL + "HXXCServiceWeChat/wechat/wechat_verify";
        } else {
            var userData = getStorage("userData");
        }

        var uid = userData.uid;
        var productid = getUrlParam("productid");
        // 获取手机号
        var mobile = userData.mobile;
        var openId =userData.openId;
        var number_ = parseInt($("#Value").text());
        var number_new = "1";
        var point = "";
        var data = "";
        var producttype = "";
        // 获取 个人 兑换 总数 用于 创建订单前校验
        var userExchangeNum=getUserExchangeNum(uid, productid);
        var aid=getUrlParam("aid"); //选择地址 返回提交订单页面 携带 id
        var addressJsonOld=getAddress(uid);// 地址数据 原始数据
        var addressJson="";// 地址数据 整理后的数据
        if(aid==""){
            if (addressJsonOld.list.length != 0) {
                addressJson = addressJsonOld.list[0];
            }
        }else{
            for(var i=0;i<addressJsonOld.list.length;i++){
                if(aid == addressJsonOld.list[i].id ){
                    addressJson=addressJsonOld.list[i];
                }
            }
        }

        init(productid);
        // 先检测 是不是 从选择地址页面回到 提交订单 页
        // 初始化页面
        function init(productid) {
            var sendUrl = APP_URL + "HXXCServiceWeChat/product/product_info_list.json?page=" + 1 + "&pageSize=4&productId=" + productid;
            fnAjax(sendUrl, "get", false, "", function(data) {
                var data = data.result.list[0];
                if(data.needRealName==1){
                    $(".realename").show();
                }
                $("#product_name").html(data.productName);
                window.exchangemaxnumber = data.exchangeMaxNumber;
                $("#eachangmaxnumber").html(exchangemaxnumber);
                window.surplusnumber = data.surplusNumber;
                window.productid = data.productId;
                window.merchantid = data.merchantId;
                window.producttype = data.productType;
                window.exchangetype = data.exchangeType;
                window.needrealname = data.needRealName;
                if (data.exchangeType == "1") {
                    window.price = data.point;
                    $(".wutubiao_fangshimiaoshu").html("花费积分");
                    $("#product_price").html("<span>" + data.point + "</span>" + "<span>积分<span/>");
                    //   cba
                    $("#cbachangstate").html("花费积分：");
                    $("#cbaMoney").html(data.point);
                } else if (data.exchangeType == "2") {
                    window.price = data.price;
                    $(".paymes").show();
                    $(".wutubiao_fangshimiaoshu").html("花费金额");
                    $("#product_price").html("<span>" + data.price + "</span>" + "<span>元</span>");
                    //   cba
                    $("#cbachangstate").html("花费金额：");
                    $("#cbaMoney").html("￥" + data.price);
                }
                window.allprice = number_ * 1 * price;
                if (producttype == 1) {
                    //实物
                    getAddressList();
                    producttype = 1;
                } else {
                    //   producttype=0
                }
            }, function(error) {
                console.log(error)
            })
        }

        //点击 加
        $("#addBtn").on("click", function() {
            //var price=$("#product_price").html();
            var numer_Value = $("#Value").text();
            var new_numer_Value = numer_Value * 1 + 1;
            var exchangemaxnumber=userExchangeNum.exchangeMaxNumber;
            if (new_numer_Value > exchangemaxnumber) {
                show_mengceng();
                if (producttype == 13) {
                    onanniu('该场次限购' + exchangemaxnumber + '张', '确定');
                } else {
                    onanniu('此商品最多只能购买' + exchangemaxnumber + '张', '确定');
                }
                i_konw_hide();
                return false;
            }
            if (new_numer_Value > surplusnumber) {
                console.log("maiduole");
                show_mengceng();
                onanniu('余票不足,请重新下单', '确定');
                i_konw_hide();
                return false;
            }
            var numex = parseInt(userExchangeNum.exchangeNum) + parseInt(new_numer_Value);
            if (parseInt(numex) > parseInt(exchangemaxnumber)) {
                console.log("maiduole");
                show_mengceng();
                if (needrealname == 1) {
                    onanniu('该场次每个用户限购' + exchangemaxnumber + '张', '确定');
                }else{
                    onanniu('用户已超过产品单次最大可购买数', '确定');
                }
                i_konw_hide();
                return false;
            }
            number_new = new_numer_Value;
            var all_price = new_numer_Value * (price * 1);
            $("#Value").text(new_numer_Value);
            $("#product_price span").eq(0).html(all_price);
            // 新增实名制信息  金额
            $(".selectedNum").text(new_numer_Value);
            $("#cbaMoney").html("￥" + all_price);
            // 实名制信息 结构
            addrealename(new_numer_Value);
        })
        // 弹出窗 点击   隐藏
        function i_konw_hide() {
            setTimeout(function() {
                $(".i_know").on("click", function() {
                    $(this).parent().remove();
                    $(".dongtaimengceng").remove();
                })
            }, 1000);
        }
        // 点击  减
        $("#jianBtn").on("click", function() {
            var jifen_number = $("#product_price").html();
            var numer_Value = $("#Value").text();
            var new_numer_Value = numer_Value * 1 - 1;
            if (new_numer_Value < 1) {
                new_numer_Value = 1;
                return false;
            }
            var all_price = new_numer_Value * (price * 1);
            number_new = new_numer_Value;
            $("#Value").text(new_numer_Value);
            $("#product_price span").eq(0).html(all_price);
            // cba
            $("#cbaMoney").html("￥" + all_price);
            $(".selectedNum").text(new_numer_Value);
            // 删除 实名制
            $(".realename_center_list").last().remove();
        })
        // 获取个人积分
        point = userPoint(uid);
        //构造参数
        function sortingParameters(productType, cardArr) {
            var data1 = "";
            // productType 1 实物商品
            if (productType == 1) {
                 data1 = {
                    "buyNumber": number_new,
                    "uid": uid,
                    "productId": productid,
                    "userMobile": mobile,
                    "mobile": addressJson.mobile,
                    "name": addressJson.name,
                    "address": addressJson.address,
                    "views": cardArr
                }
            } else {
                 data1 = {
                    "buyNumber": number_new,
                    "uid": uid,
                    "productId": productid,
                    "userMobile": mobile,
                    "views": cardArr
                }
            }
            return data1;
        }

        // 点击  确定
        $("#queding_btn").on("click", function() {
            // 姓名 身份证号 数组
            var cardArr = funcarArr();
            // sortingParameters(producttype, cardArr);
            // if (cardArr.length != window.data1.buyNumber || cardArr.length == 0) {
            if (cardArr.length != $("#Value").text() || cardArr.length == 0) {
                show_mengceng();
                onanniu("请补全信息", "确定");
                i_konw_hide();
                return false;
            } else {
                var state_ = true;
                var arrcard = [];
                for (var i in cardArr) {
                    if (!funblur(cardArr[i].idCard)) {
                        state_ = false;
                        show_mengceng();
                        onanniu("请填写正确的身份证号", "知道了");
                        i_konw_hide();
                        break;
                    } else {
                        arrcard.push(cardArr[i].idCard);
                    }
                }

                if (!state_) {
                    return false;
                }
                if (deleteEle(arrcard) == "repeat") {
                    show_mengceng();
                    onanniu("重复身份证号", "知道了");
                    i_konw_hide();
                    return false;
                }
            }

            if (exchangetype == "1") {
                if (allprice - point * 1 > 0) {
                    alert("积分不足");
                    return false;
                }
            }
            if (parseInt(userExchangeNum.exchangeNum) >= parseInt(userExchangeNum.exchangeMaxNumber) || (parseInt(userExchangeNum.exchangeNum) + number_) > parseInt(userExchangeNum.exchangeMaxNumber)) {
                alert("已超过最大兑换数，无法兑换");
                return false;
            }

            if (userExchangeNum.exchangeMaxNumber >= number_new) {
                var createOrderSendData=JSON.stringify(sortingParameters(producttype,cardArr));
                var orderData=createOrder(createOrderSendData);
                if (orderData.state == 0) {
                    if (orderData.result.tradeNo != 0) {
                        //拉微信支付
                        var orderNo = orderData.result.orderNo;
                       var jsonobj={};
                       var WXPaySign=getWXPaySign(orderNo,openId);
                       jsonobj.appId = WXPaySign.appId;
                       jsonobj.nonceStr = WXPaySign.nonceStr;
                       jsonobj.package = WXPaySign.package;
                       jsonobj.paySign = WXPaySign.paySign;
                       jsonobj.signType = WXPaySign.signType;
                       jsonobj.timeStamp = WXPaySign.timeStamp;
                       parkingPay(jsonobj,orderNo,productid);
                    } else {
                        //积分
                        location.href = "changeSuccess.html?shangxun_orderNo=" + orderData.result.orderNo;
                    }
                } else {
                    //   错误提示
                    $(".mengceng").show();
                    onanniu(orderData.message, "确定");
                    $(".i_know").on("click", function() {
                        $(".mengceng").hide();
                        $("#onanniubox").remove();
                    })
                    console.log(orderData.result);
                }

            } else {
                // 库存不足，无法兑换  错误提示
                $(".mengceng").show();
                onanniu("余票不足，请重新下单", "确定");
                $(".i_know").on("click", function() {
                    $(".mengceng").hide();
                    $("#onanniubox").remove();
                })
                return false;
            }
        })

        function getAddressList() {
            // alert("addressJson");
            // alert(addressJson);
            console.log(addressJson);
            if (addressJson != undefined) {
                $(".dizhi_liebiao").show();
                $("#name").html(addressJson.name);
                $("#mobile").html(addressJson.mobile);
                $("#address").html(addressJson.address);
            } else {
                $("#add_address_btn").show();
            }
        }
        //新增
        $("#add_address_btn").on("click", function() {
            location.href ="../addressList/addOrEditTicketAddress.html?type=add";
        })
        //跳到地址列表
        $("#change_address").on("click", function() {
            location.href = "../addressList/chooseAddress.html?productid=" + productid;
        })

        /*提示框 一个按钮的*/
        function onanniu(centen_wenzi, anniu_wenzi) {
            var tishikuang_html =
                "<div id='onanniubox' style='width: 80%;position: fixed;background: #ffffff; border-radius: 0.04rem; left: 10%;top: 1.2rem;z-index:9999' class='onekuang'><div style='padding-bottom: 0.36rem;padding-top: 0.4rem;text-align: center;border-bottom: 1px solid rgb(230,230,203);color: rgb(51,51,51);font-size: 0.16rem;'>" +
                centen_wenzi +
                "</div><div style='margin:0.2rem 0 ;width: 80%;margin-left: 10%;height: 0.4rem;background: rgb(255,221,16);border-radius: 0.2rem;font-size: 0.16rem;color: rgb(51,51,51);text-align: center;line-height: 0.4rem;' class='i_know'>" +
                anniu_wenzi + "</div></div>";
            $("body").append(tishikuang_html);
        }

        function ObjStory(name, card) //声明对象
        {    
            this.name = name;    
            this.idCard = card;
        }
        // 实名制信息 结构
        function addrealename(num) {
            var shimingHtml = '<div class="realename_center_list">' +
                '<div class="list_num"><p>' + num + '</p></div>' +
                '<div class="list_nameID">' +
                '<div class="list_name" change=0>' +
                '<p>真实姓名：</p>' +
                '<input type="text" placeholder="请填写身份证上的姓名" class="input_empty list_name_input" onfocus="inputFocus(this)" onkeyup="inputKeyup(this)">' +
                '<div class="empty" onclick="empty_(this)"><img src="pic/icon_closecard.png"/></div>' +
                '</div>' +
                '<div class="list_ID">' +
                '<p>身份证号：</p>' +
                '<input type="text" placeholder="请填写正确的身份证号码" class="input_empty list_id_input" onfocus="inputFocus(this)" onkeyup="inputKeyup(this)">' +
                '<div class="empty" onclick="empty_(this)"><img src="pic/icon_closecard.png"/></div>' +
                '</div>' +
                '</div>' +
                '</div>';
            $(".realename_center_namebox").append(shimingHtml);
        }

        //    创建 姓名 身份证号 数组
        function funcarArr() {
            var cardArr = new Array(); //声明数组，用来存储标题信息
            var cardName = $(".list_name_input");
            var cardId = $(".list_id_input");
            for (var i in cardId) {
                if (i == "length") {
                    break;
                } else {
                    var name_ = cardName[i].value;
                    var id_ = cardId[i].value;
                    if (name_ == "" && id_ == "") {
                        break;
                    }
                    cardArr.push(new ObjStory(name_, id_));
                }
            }
            return cardArr;
        }


    </script>

</body>

</html>
