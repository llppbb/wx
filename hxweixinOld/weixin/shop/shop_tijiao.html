<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="format-detection" content="telephone=no" />
    <meta name="format-detection" content="email=no" />
    <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" id="viewport" name="viewport">
    <title>提交订单</title>
    <link rel="stylesheet" href="weixin/shop/css/tijiao.css">
    <link rel="stylesheet" href="weixin/shop/css/common.css">
</head>

<body>
    <div class="wrap">
        <!-- <div class="shengyuTime">
                <p class="font_14_color_51">支付剩余时间：<span class="font_14_color_233" id="showData">09分59秒</span></p>
            </div> -->
        <div class="project_name">
            <p id="product_name"></p>
        </div>
        <div class="project_number">
            <p>数量</p>
            <div class="choose_seesion_centen choose_seesion_centen_jisuan">
                <div class="choose_seesion_jisuan choose_seesion_jian" id="jianBtn">
                    <p>﹣</p>
                </div>
                <div class="choose_seesion_jisuan choose_seesion_number" id="Value">1</div>
                <div class="choose_seesion_jisuan choose_seesion_add" id="addBtn">﹢</div>
            </div>
        </div>
        <div class="zhifuFangshi">
            <div class="fangshimiaoshu fangshimiaoshu_weixin">
                <p class="wutubiao_fangshimiaoshu">花费积分</p>
                <div class="tishi_tupain wutubiao_number" id="product_price">0</div>
            </div>
            <!-- <div class="fangshimiaoshu fangshimiaoshu_weixin">
                    <p class="wutubiao_fangshimiaoshu">花费积分</p>
                    <div class="tishi_tupain wutubiao_number">2000</div>
                </div>-->
        </div>

        <!--添加收货地址-->
        <div class="tianjiashouhuodizhi" id="add_address_btn" style="display:none">
            <img src="weixin/shop/pic/icon_add.png" class="icon_add" />
            <p class="font_15_color_51">请添加收货地址</p>
            <img src="weixin/shop/pic/gengduo.png" class="jianhao" />
        </div>
        <!--收货地址列表-->
        <div class="dizhi_liebiao" style="display:none">
            <div class="xingmingshoujihao">
                <p class="font_15_color_51 xingmingshoujihao_p1" id="name">张三</p>
                <p class="font_15_color_51 xingmingshoujihao_p2" id="mobile">13488889999</p>
            </div>
            <div class="xiangxidizhi">
                <p class="font_14_color_128" id="address">北京市朝阳区 姚家园南里1号院惠通时代广场9号院 微赛时代</p>
            </div>
            <div class="jianhao" id="change_address">
                <img src="weixin/shop/pic/gengduo.png" />
            </div>
        </div>

        <!--<div class="zhifuFangshi">
                <div class="fangshimiaoshu">支付方式</div>
                <div class="fangshimiaoshu fangshimiaoshu_weixin">
                    <div class="weixin_tupian"><img src="pic/icon_selected_wx.png" /></div>
                    <p>微信</p>
                    <div class="tishi_tupain"><img src="pic/Group.png" /></div>
                </div>
            </div>-->
        <div class="paymes" style="display:none">提交订单后请在<span>2</span>分钟内进行支付</div>
        <div class="footerHeji">
            <div class="zhifuBtn" id="queding_btn">确定</div>
        </div>

    </div>

    <div class="guoqi_tishi" style="display: none;">该订单已过期<br/>请重新下单</div>
    <!--支付失败 微信 支付宝  提示-->
    <div class="mengceng" style="display: none;"></div>
    <div class="weidenglu_tishi zhifushibai" style="display: none;">
        <div class="weidenglu_tishi_title">
            <p class="weidenglu_tishi_title_p2">支付失败！订单会为您保留10分钟，请您尽快支付</p>
        </div>
        <div class="weidenglu_tishi_bottom">
            <div class="i_know">我知道了</div>
        </div>
    </div>

    <script src="weixin/common/jquery.js"></script>
    <script src="weixin/common/fontSize.js"></script>
    <script src="weixin/common/common.js"></script>
    <script src="weixin/common/md5.js"></script>
    <script type="text/javascript" src="https://pingjs.qq.com/h5/stats.js" name="MTAH5" sid="500338441"></script>

    <script src="weixin/shop/js/common.js"></script>
    <script>
        var addressJson = <?php print_r($addressJson)?>;
        //console.log(<?php print_r($addressJson)?>);
        var uid = "<?php echo $uid?>";
        var productid = "<?php echo $productid?>";
        // 获取手机号
        var mobile = "<?php echo $mobile?>";
        var uid = "<?php echo $uid?>";
        var openId = "<?php echo $openid?>";
        var number_ = parseInt($("#Value").text());
        var number_new = "1";
        var point = "";
        var data = "";
        var producttype = "";


        // 调用 倒计时
        // getNowFormatDate();
        // //alert(currentdate_end);
        //   var _TimeCountDown = new TimeCountDown("showData",{
        //            startTime:currentdate_start,    //开始时间
        //            endTime:currentdate_end,  //结束时间 
        //            timeCallBack:"timeOverfun", //回调函数
        //      });

        histroy_num();
        $.ajax({
            type: "post",
            url: COUPON_URL + "Home/Requestajax/getGoodsList",
            async: false,
            dataType: "json",
            data: {
                "sign": md5_sign_tmp,
                "timestamp": tmp,
                "productId": productid
            },
            success: function(data) {
                console.log(data);
                var data = data.result[0].list[0];
                $("#product_name").html(data.productname);
                window.exchangemaxnumber = data.exchangemaxnumber;
                // window.exchangenumNew = data.exchangenum;
                window.surplusnumber = data.surplusnumber;
                window.productid = data.productid;
                window.merchantid = data.merchantid;
                window.producttype = data.producttype;
                window.exchangetype = data.exchangetype;
                if (data.exchangetype == "1") {
                    window.price = data.point;
                    $(".wutubiao_fangshimiaoshu").html("花费积分");
                    $("#product_price").html("<span>" + data.point + "</span>" + "<span>积分<span/>");
                } else if (data.exchangetype == "2") {
                    window.price = data.price;
                    $(".paymes").show();
                    $(".wutubiao_fangshimiaoshu").html("花费金额");
                    $("#product_price").html("<span>" + data.price + "</span>" + "<span>元</span>");
                }
                window.allprice = number_ * 1 * price;
                if (producttype == 1) {
                    //实物
                    getAddressList();
                    producttype = 1;
                } else {
                    producttype = 0
                }
            },
            error: function() {
                // alert("错误")
            }
        })

        //点击 加
        $("#addBtn").on("click", function() {
            //var price=$("#product_price").html();
            var numer_Value = $("#Value").text();
            var new_numer_Value = numer_Value * 1 + 1;
            if (new_numer_Value > exchangemaxnumber) {
                console.log("maiduole");
                show_mengceng();
                onanniu('此商品最多只能购买' + exchangemaxnumber + '张', '确定');
                i_konw_hide();
                return false;
            }
            if (new_numer_Value > surplusnumber) {
                console.log("maiduole");
                show_mengceng();
                onanniu('余票不足,请重新下单', '确定');
                i_konw_hide();
                return false;
            }
            var numex = parseInt(exchangenum) + parseInt(new_numer_Value);
            // alert(numex);
            // alert(exchangemaxnumber);
            if (parseInt(numex) > parseInt(exchangemaxnumber)) {
                console.log("maiduole");
                show_mengceng();
                onanniu('用户已超过产品单次最大可购买数', '确定');
                i_konw_hide();
                return false;
            }
            number_new = new_numer_Value;
            $("#Value").text(new_numer_Value);
            var all_price = new_numer_Value * (price * 1);
            $("#product_price span").eq(0).html(all_price);
        })
        // 弹出窗 点击   隐藏
        function i_konw_hide() {
            setTimeout(function() {
                $(".i_know").on("click", function() {
                    $(this).parent().remove();
                    $(".dongtaimengceng").remove();
                })
            }, 1000);
        }
        // 点击  减
        $("#jianBtn").on("click", function() {
            var jifen_number = $("#product_price").html();
            //alert(jifen_number);
            var numer_Value = $("#Value").text();
            var new_numer_Value = numer_Value * 1 - 1;
            if (new_numer_Value < 1) {
                new_numer_Value = 1;
                return false;
            }
            var all_price = new_numer_Value * (price * 1);
            $("#product_price span").eq(0).html(all_price);
            number_new = new_numer_Value;
            $("#Value").text(new_numer_Value);
        })
        // 获取个人积分
        $.ajax({
            url: WX_URL + 'requestAjax.php',
            type: 'POST',
            dataType: 'json',
            async: false,
            data: {
                'uid': uid,
                'identity': 'getUserPoint'
            },
            success: function(res) {
                // 获取 个人积分
                point = res.result.point;
                //alert(point);
            },
            error: function() {
                alert("获取个人积分 失败")
            }
        })
        // 获取用户历史兑换数量
        function histroy_num() {
            $.ajax({
                type: "post",
                //url:"https://coupon.dev.huaxiweiying.com/Home/Requestajax/zishoplist",
                url: COUPON_URL + "Home/Requestajax/getUserExchangeNum",
                async: false,
                dataType: "json",
                data: {
                    "sign": md5_sign_tmp,
                    "timestamp": tmp,
                    "uid": uid,
                    "productId": productid
                },
                success: function(data) {
                    //已购买总数
                    window.buytotalnumber = data.result.buytotalnumber;
                    //目前剩余总数
                    window.now_surplusnumber = data.result.surplusnumber;
                    //单个用户最大兑换数
                    window.now_exchangemaxnumber = data.result.exchangemaxnumber;
                    //用户历史购买数量
                    window.exchangenum = data.result.exchangenum;
                    console.log(data);
                },
                error: function(e) {
                    console.log(e)
                }
            })
        }

        function fun(a) {
            var data1 = "";
            if (a == 1) {
                window.data1 = {
                    "buyNumber": number_new,
                    "uid": uid,
                    "productId": productid,
                    "userMobile": mobile,
                    "mobile": addressJson.mobile,
                    "name": addressJson.name,
                    "address": addressJson.address
                }
            } else {
                window.data1 = {
                    "buyNumber": number_new,
                    "uid": uid,
                    "productId": productid,
                    "userMobile": mobile
                }
            }
            console.log(window.data1);
            return data1;
        }

        // 点击  确定
        $("#queding_btn").on("click", function() {
            fun(producttype);

            // console.log("exchangetype:"+exchangetype)
            // return;
            if (exchangetype == "1") {
                if (allprice - point * 1 > 0) {
                    alert("积分不足");
                    return false;
                }
            }
            if (parseInt(exchangenum) >= parseInt(now_exchangemaxnumber) || (parseInt(exchangenum) + number_) > parseInt(now_exchangemaxnumber)) {
                alert("已超过最大兑换数，无法兑换");
                return false;
            }

            //  alert(now_surplusnumber);
            //   alert(number_); 剩余票数 大于
            if (now_surplusnumber >= number_new) {
                $.ajax({
                    type: "post",
                    url: COUPON_URL + "Home/Requestajax/createOrder",
                    async: false,
                    dataType: "json",
                    data: createSign(data1),
                    success: function(data) {
                        if (data.state == 0) {
                            if (data.result.tradeNo != 0) {
                                //拉微信支付
                                console.log(data.result);

                                var tradeNo = data.result.tradeNo;
                                location.href = WX_URL + "user.php?WXPay=1&tradeNo=" + tradeNo;
                            } else {
                                //积分
                                location.href = WX_URL + "user.php?duihuan_success=1&shangxun_orderNo=" + data.result.orderNo;
                            }
                        } else {
                            //   错误提示
                            // alert(data.result);
                            $(".mengceng").show();
                            onanniu(data.result, "确定");
                            $(".i_know").on("click", function() {
                                $(".mengceng").hide();
                                $("#onanniubox").remove();
                            })
                            console.log(data.result);
                        }

                    },
                    error: function(e) {
                        console.log(e)
                    }
                })
            } else {
                // 库存不足，无法兑换  错误提示
                $(".mengceng").show();
                onanniu("余票不足，请重新下单", "确定");
                $(".i_know").on("click", function() {
                    $(".mengceng").hide();
                    $("#onanniubox").remove();
                })
                return false;
            }

        })

        function getAddressList() {
            if (addressJson != "") {
                //alert("you");
                $(".dizhi_liebiao").show();
                console.log(addressJson)
                $("#name").html(addressJson.name);
                $("#mobile").html(addressJson.mobile);
                $("#address").html(addressJson.address);
            } else {
                //alert("mei");
                $("#add_address_btn").show();
            }
        }
        //新增
        $("#add_address_btn").on("click", function() {
            location.href = WX_URL + "user.php?addressList=1&addOrEditTicketAddress=add"
        })
        //跳到地址列表
        $("#change_address").on("click", function() {
            location.href = WX_URL + "user.php?addressList=1&chooseAddress=1&productid=" + productid
        })

        /*提示框 一个按钮的*/
        function onanniu(centen_wenzi, anniu_wenzi) {
            var tishikuang_html =
                "<div id='onanniubox' style='width: 80%;position: fixed;background: #ffffff; border-radius: 0.04rem; left: 10%;top: 1.2rem;z-index:9999' class='onekuang'><div style='padding-bottom: 0.36rem;padding-top: 0.4rem;text-align: center;border-bottom: 1px solid rgb(230,230,203);color: rgb(51,51,51);font-size: 0.16rem;'>" +
                centen_wenzi +
                "</div><div style='margin:0.2rem 0 ;width: 80%;margin-left: 10%;height: 0.4rem;background: rgb(255,221,16);border-radius: 0.2rem;font-size: 0.16rem;color: rgb(51,51,51);text-align: center;line-height: 0.4rem;' class='i_know'>" +
                anniu_wenzi + "</div></div>";
            $("body").append(tishikuang_html);
        }
        // $(".mengceng").show();
        // onanniu("余票不足，请重新下单", "确定");
        // $(".i_know").on("click",function(){
        //     $(".mengceng").hide();
        //     $("#onanniubox").remove();
        // })
    </script>

</body>

</html>
