<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="format-detection" content="telephone=no" />
    <meta name="format-detection" content="email=no" />
    <title>订单</title>
    <link rel="stylesheet" type="text/css" href="weixin/shop/css/common.css" />
</head>

<style>
    * {
        margin: 0px;
        padding: 0px;
    }

    html,
    body,
    .wrap {
        width: 100%;
        min-height: 100%;
        background: rgb(244, 244, 244);
    }

    html {
        font-size: 100px;
    }

    body,
    .wrap {
        font-size: 14px;
    }

    .img_state {
        width: 0.685rem;
        height: 0.7rem;
        position: absolute;
        right: 0.48rem;
        top: 50%;
        margin-top: -0.38rem;
    }

    .img_state img {
        width: 100%;
        height: 100%;
    }
    /*没有订单的时候*/

    .goupiaoNo {
        width: 100%;
        text-align: center;
        padding-top: 0.825rem;
    }

    .goupiaoNo img {
        width: 30%;
    }

    .goupiaoNo p {
        color: #9E9E9E;
        font-size: 0.22rem;
        color: #333333;
        margin-top: 0.1rem;
    }

    .goupiaoNo div {
        width: 35%;
        height: 0.4rem;
        line-height: 0.4rem;
        margin-top: 0.405rem;
        margin-left: 32.5%;
        text-align: center;
        font-family: "微软雅黑";
        background: #FFDD10;
        font-size: 0.16rem;
        border-radius: 0.2rem;
    }
    /*订单页 新增  商品 图片     5.9*/

    .product_img {
        width: 0.532rem;
        height: 0.482rem;
        position: absolute;
        left: 0.14rem;
        /*top: 32%;*/
        top: 50%;
        margin-top: -0.26rem;
        border-radius: 0.04rem;
    }

    .product_img img {
        width: 100%;
        height: 100%;
        border-radius: 0.04rem;
    }

    .dingdan_list {
        padding-left: 0.745rem;
    }

    .dingdan_list_number_state {
        padding-top: 0px !important;
    }

    .goaddress {
        width: 1.2rem;
        height: .24rem;
        margin-left: 1.5rem;
        text-align: center;
        line-height: .24rem;
        border-radius: .2rem;
        background: rgb(255, 221, 16);
        margin-top: .1rem;
    }

    .dingdan_list {
        padding-bottom: .15rem;
    }

    .addtime {
        height: .32rem;
        line-height: .32rem;
        border-bottom: 1px solid rgb(230, 230, 230);
        font-size: .14rem;
        color: rgb(179, 179, 179);
        position: relative;
        padding-left: .13rem;
    }

    .rtImg {
        height: .32rem;
        position: absolute;
        right: 0px;
        top: 0px;
    }

    .dingdan {
        clear: both;
    }

    .tabs {
        width: 100%;
        clear: both;
        height: .45rem;
        background: #ffffff;
    }

    .tablist {
        width: 33.33%;
        float: left;
        line-height: .45rem;
        text-align: center;
    }

    .tablist span {
        color: rgb(150, 150, 150);
        font-size: .13rem;
    }

    .tabliston {
        padding-bottom: .12rem;
        color: rgb(255, 221, 0) !important;
        border-bottom: 2px solid rgb(255, 221, 0);
    }
</style>

<body>
    <div class="wrap">
        <div class="tabs">
            <div class="tablist" idx="1" id="normal"><span class="tabliston">可使用</span></div>
            <div class="tablist" idx="2"><span>过期/已使用</span></div>
            <div class="tablist" idx="0" id="needreceinfo" style="display:none"><span>待补全信息</span></div>
        </div>
        <!--修改 5.11-->
        <div class="dingdan">
            <!--<div class="dingdan_list">
                    <div class="dingdan_list_name">买到的哈佛爱回收大佛天河石地服 </div>
                    <div class="dingdan_list_number_state">
                        <div class="dingdan_list_number">
                            1件<span>免费</span>
                        </div>
                    </div>
                    <div class="jianhao"><img src="pic/gengduo.png" /></div>
                    <div class="img_state"></div>
                </div>-->
        </div>

        <!--没有积分商城订单-->
        <div id="jifenNo" class="goupiaoNo" style="display: none;">
            <img src="weixin/shop/pic/icon_order.png" />
            <p style="fontSize:.14rem;color:rgb(128,128,128)">暂无订单</p>
        </div>

    </div>
    <script src="weixin/common/jquery.js"></script>
    <script src="weixin/common/fontSize.js"></script>
    <script src="weixin/common/common.js"></script>
    <script src="weixin/common/md5.js"></script>
    <script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script type="text/javascript" src="https://pingjs.qq.com/h5/stats.js" name="MTAH5" sid="500338441"></script>
    <script>
        window.onpageshow = function(event) {
            if (event.persisted) {
                window.location.reload();
            }
        };
        var tmp = Date.parse(new Date()).toString();
        tmp = tmp.substr(0, 10);
        var sign_tmp = "SDE45FHW6KL" + tmp;
        var md5_sign_tmp = hex_md5(sign_tmp);
        getNowFormatDate();
        var uid = "<?php echo $uid?>";
        var nohouse="<?php echo $nohouse?>";
        console.log("nohouse"+nohouse);
        if(nohouse!=1){
            // 返回  商城 主页
            goHomeBtn('body');
        }
        // var uid = "2013994418136";

        // getlsitarr(0);

        $(".tablist").on("click", function() {
            $(this).find('span').addClass('tabliston').parent().siblings('').find('span').removeClass('tabliston');
            var idx=$(this).attr("idx");
            $(".dingdan").show();
            $("#jifenNo").hide();
            getlsitarr(idx);
        })

        function getlsitarr(type) {
            $.ajax({
                type: "post",
                url: COUPON_URL + "Home/Requestajax/getOrderInfoListNew",
                async: false,
                dataType: "json",
                data: {
                    "sign": md5_sign_tmp,
                    "timestamp": tmp,
                    "uid": uid
                },
                success: function(data) {
                    console.log(data);
                    var data_ = data.result;
                    var arridx='';
                    var typedata='';
                    // console.log(data_);
                    $(".dingdan").html("");
                        if(type==0){
                            if(data_.needreceinfo.length==0){
                                // alert("没有地址列表");
                                // $("#normal").find("span").addClass('tabliston');
                                if(data_.normal.length==0){
                                   $(".dingdan").hide();
                                   $("#jifenNo").show();
                                   return false;
                               }else{
                                   $("#needreceinfo").show();
                                   arridx=data_.normal;
                                   typedata="normal";
                               }
                            }else{
                                // alert("有地址列表");
                                arridx=data_.needreceinfo;
                                typedata="needreceinfo";
                            }
                        }else if(type==1){
                            console.log(data_.normal.length);
                            // $("#normal").find("span").addClass('tabliston');
                            if(data_.normal.length==0){
                               $(".dingdan").hide();
                               $("#jifenNo").show();
                               return false;
                           }else{
                               arridx=data_.normal;
                               typedata="normal";
                           }

                           if(data_.needreceinfo.length!=0){
                              $("#needreceinfo").show();
                           }

                        }else if(type==2){
                            if(data_.isexpire.length==0){
                               $(".dingdan").hide();
                               $("#jifenNo").show();
                               return false;
                           }else{
                                arridx=data_.isexpire;
                                typedata="isexpire";
                            }
                        }
                        addhtml(arridx,typedata);
                },
                error: function() {
                    // alert("错误")
                }
            })
        }

        getlsitarr(1);

        function addhtml(arr,type){
            console.log(arr);
            var list_html='';
            $.each(arr, function(i, k) {
                var usestatus = ""  //控制显示商品是否过期
                var paytype = "";
                var addtimeHtml = '';
                var goaddress='';
                var typeName = '';
                var rafflename = '';
                if (k.paytype == 0) { // 免费
                    paytype = "免费"
                } else if (k.paytype == 1) {
                    paytype = k.totalpoint + "积分";
                } else if (k.paytype == 3) {
                    paytype = k.totalprice + "元";
                }

                if(k.ordertype==1){
                    // 抽奖
                    if (k.typename != null) {
                        typeName = k.typename;
                    }
                    if (k.rafflename != null) {
                        rafflename=k.rafflename;
                    }else{
                        rafflename = k.shopname;
                    }
                    addtimeHtml = '<div class="addtime">抽奖时间：' + k.addtime + '<img src="weixin/shop/pic/icon_jp.png" class="rtImg"/></div>';
                }else if(k.ordertype==2){
                    // 竞拍
                    addtimeHtml = '<div class="addtime">竞拍时间：' + k.addtime + '<img src="weixin/shop/pic/label_auction.png" class="rtImg"/></div>';
                }else if(k.ordertype==0){
                    addtimeHtml = '<div class="addtime">兑换时间：' + k.addtime + '<img src="weixin/shop/pic/label_convert.png" class="rtImg"/></div>';
                }


                if (type == "isexpire") { //商品 过期 已使用
                     clat = "top:60%;";
                     if(k.useStatus==1){
                         usestatus = '<img src="weixin/shop/pic/icon_Already_use.png"/>';
                     }else{
                         usestatus = '<img src="weixin/shop/pic/icon_overdue.png"/>';
                     }
                }else if(type == "needreceinfo"){  //补全地址信息
                    console.log("needreceinfo");
                     goaddress = '<div class="goaddress">补全收货信息</div>';
                     usestatus = '';
                     clat = "top:41%;";
                }else if(type == "normal"){  //正常订单
                    console.log("normal");
                     clat = "top:60%;";
                     usestatus="";
                }
                list_html +=
                    '<div class="dingdan_list" onclick="clicklist(this)" ordertype="' + k.ordertype + '" producttype="' + k.producttype + '" orderno=' + k.orderno + ' isPrize='+k.isprize+' style="padding-left:.0rem">' +
                    addtimeHtml +
                    '<div className="boxR" style="padding-left:.745rem">' +
                    '<div class="product_img" style=' + clat + '>' +
                    '<img src="' + k.productimage + '"/>' +
                    '</div>' +
                    '<div class="dingdan_list_name">' + k.productname + '</div>' +
                    '<div class="dingdan_list_number_state"  style="margin-top:.14rem">' +
                    '<div class="dingdan_list_number">' + rafflename + '</div>' +
                    '<div class="dingdan_list_number" style="margin-top:.14rem">' +
                    '数量:' + k.buynumber + '<span>' + paytype + '</span><span>' + typeName + '</span>' + '</div>' +
                    '</div>' +
                    '<div class="jianhao" style=' + clat + '><img src="weixin/shop/pic/gengduo.png" /></div>' +
                    '<div class="img_state" style=' + clat + '>' + usestatus + '</div>'+goaddress+'</div></div>';
            });
            $(".dingdan").html(list_html);
        }

        // 获取系统时间
        function getNowFormatDate() {    
            var date = new Date();    
            var seperator1 = "-";    
            var seperator2 = ":";    
            var month = date.getMonth() + 1;    
            var strDate = date.getDate();    
            if (month >= 1 && month <= 9) {        
                month = "0" + month;    
            }    
            if (strDate >= 0 && strDate <= 9) {        
                strDate = "0" + strDate;    
            }    
            window.currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate + " " + date.getHours() + seperator2 + date.getMinutes() + seperator2 + date.getSeconds();   
        }

        // 时间的 差值
        function GetDateDiff(startTime, endTime, diffType) {
            //将xxxx-xx-xx的时间格式，转换为 xxxx/xx/xx的格式
            startTime = startTime.replace(/-/g, "/");
            endTime = endTime.replace(/-/g, "/");
            //将计算间隔类性字符转换为小写
            diffType = diffType.toLowerCase();
            var sTime = new Date(startTime); //开始时间
            var eTime = new Date(endTime); //结束时间
            //作为除数的数字
            var divNum = 1;
            switch (diffType) {
                case "second":
                    divNum = 1000;
                    break;
                case "minute":
                    divNum = 1000 * 60;
                    break;
                case "hour":
                    divNum = 1000 * 3600;
                    break;
                case "day":
                    divNum = 1000 * 3600 * 24;
                    break;
                default:
                    break;
            }
            window.time_yu = parseInt((eTime.getTime() - sTime.getTime()) / parseInt(divNum))
            return parseInt((eTime.getTime() - sTime.getTime()) / parseInt(divNum));
        }

        //是计算秒数
        // var cha=parseInt((eTime.getTime() - sTime.getTime()) / parseInt(divNum));


        function clicklist(obj){
            var orderno1 = $(obj).attr("orderno");
            var producttype = $(obj).attr("producttype");
            var isPrize = $(obj).attr("isPrize");
            var ordertype = $(obj).attr("ordertype");
            location.href = WX_URL + "user.php?dingdan_xiangqing=1&shangxun_orderNo=" + orderno1 + "&producttype=" + producttype + "&isPrize=" + isPrize+"&ordertype=" + ordertype+"&nohouse=" + nohouse;
        }

        $("#gopiao").on("click", function() {
            location.href = WX_URL + "user.php?shop=1";
        })

        var appId = '<?php echo APPID?>';
        var nonceStr = '<?php echo $nonceStr;?>';
        var timestamp = '<?php echo $timestamp;?>';
        var signature = '<?php echo $signature;?>';
        // 微信分享
        wx.config({
            debug: false,
            appId: appId,
            timestamp: timestamp,
            nonceStr: nonceStr,
            signature: signature,
            jsApiList: ['checkJsApi', 'onMenuShareAppMessage']
        });
        wx.ready(function() {
            wx.checkJsApi({
                jsApiList: ['onMenuShareAppMessage'],
                success: function(res) {
                    console.log(res);
                }
            });
            wx.onMenuShareAppMessage({
                title: '吃喝玩乐 华熙LIVE一卡通', // 分享标题
                desc: '越多积分，越多实惠！', // 分享描述
                link: WX_URL + 'user.php?dingdan=1', // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                imgUrl: WX_URL + 'tmp/title.png', // 分享图标
                type: '', // 分享类型,music、video或link，不填默认为link
                dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
                success: function() {
                    // 用户确认分享后执行的回调函数
                    console.log("分享成功");
                },
                cancel: function() {
                    // 用户取消分享后执行的回调函数
                    console.log("取消分享");
                }
            });
        });
        wx.error(function(res) {
            // console.log(res);
        });
    </script>
</body>

</html>
