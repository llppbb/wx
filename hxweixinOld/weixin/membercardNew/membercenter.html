<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="format-detection" content="telephone=no" />
    <meta name="format-detection" content="email=no" />
    <!--禁止页面缩放-->
    <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" id="viewport" name="viewport">
    <title>会员中心</title>
    <link rel="stylesheet" type="text/css" href="weixin/common/common.css" />
    <link rel="stylesheet" type="text/css" href="weixin/membercardNew/css/activatecar.css" />
    <link rel="stylesheet" type="text/css" href="weixin/membercardNew/css/bindMobile.css" />
    <link rel="stylesheet" type="text/css" href="weixin/common/common.css" />
    <link rel="stylesheet" type="text/css" href="weixin/membercardNew/css/membercenter.css" />
</head>
<style>
    html,body{
        background: #fff;
    }
    .usepoint {
        font-size: .14rem;
        position: relative;
        background: #E8375E;
        height: .19rem;
        line-height: .19rem;
        border-bottom-right-radius: .08rem;
        border-top-right-radius: .08rem;
        color: #ffffff;
        padding-right: .15rem;
    }

    .usepointfont {
        margin-left: .3rem;
    }

    .colorp {
        background: rgb(232, 55, 94);
    }

    .colory {
        background: rgb(190, 190, 190);
    }

    .colorj {
        background: rgb(210, 167, 66);
    }

    .colorh {
        background: rgb(51, 51, 51);
    }

    .colorz {
        /*margin-left: .6rem;*/
        background: rgb(97, 180, 240);
    }

    .icon_img {
        position: absolute;
        left: 0.125rem;
        top: .03rem;
        width: .12rem;
    }

    .dengjifont {
        margin-top: 0.05rem !important;
        position: absolute;
        left: 0;
        bottom: 0px;
    }

    .carmiaoshu {
        font-size: .14rem;
        color: rgb(51, 51, 51) !important;
    }
    /*幸运球弹窗*/

    .luckball {
        display: none;
        width: 80%;
        position: fixed;
        top: 10%;
        left: 10%;
        z-index: 100;
    }

    .luckballbigpic {
        width: 100%;
        display: block;
    }

    .luckballbigpic img {
        width: 100%;
    }

    .receiveBtn {
        width: 50%;
        height: .45rem;
        background: #FF5687;
        border-radius: 4px;
        text-align: center;
        line-height: .45rem;
        color: #ffffff;
        font-size: .18rem;
        margin-top: .2rem;
        margin-left: 25%;
    }

    .closeluckball {
        position: absolute;
        right: -.1rem;
        top: -.1rem;
        width: .2rem;
    }

    .closeluckball img {
        width: 100%;
    }

    .headbg {
        position: relative;
    }

    .hyqi {
        background: #E09AAA;
        width: .645rem;
        height: .12rem;
        border-radius: .04rem;
        color: #ffffff;
        font-size: .11rem;
        line-height: .12rem;
        padding-left: .05rem;
        padding-right: .05rem;
        margin-left: .1rem;
    }

    #havepoint {
        width: 80%;
        margin-left: 10%;
    }

    .tab {
        border: none;
        background: none;
        height: auto;
    }

    .tab div {
        width: 48%;
        float: left;
        text-align: center;
        height: .71rem;
        padding-top: .17rem;
        background: #f4f4f4;
        margin-top: 0px;
    }

    #nowpoint {
        position: relative;
    }

    .hyqipk {
        background: #E09AAA;
    }

    .hyqiyk {
        background: #DEDEDE;
    }

    .hyqijk {
        background: #E4C578;
    }

    .hyqihk {
        background: #787878;
    }

    .hyqizsk {
        background: #A6D4ED;
    }

    .luckballBox {
        width: .78rem;
        position: absolute;
        right: .03rem;
        top: 38%;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }

    .luckballIcon {
        width: 100%;
        position: absolute;
        z-index: 50;
        right: .03rem;
        top: 0;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }

    .luckballFloatIcon {
        /*width: .8rem;*/
        height: .21rem;
        position: absolute;
        left: -.3rem;
        top: .26rem;
    }

    .select {
        width: 100%;
        padding: .11rem 0 .11rem .31rem;
        font-size: .13rem;
        color: #333333;
        outline: none;
        border: none;
        background: #fff;
        box-shadow: 1px 1px 3px #ccc;
    }

    .selectBox {
        position: relative;
        display: none;
    }

    .icon_address {
        position: absolute;
        left: .14rem;
        top: 50%;
        margin-top: -.07rem;
        height: .13rem;
    }

    .icon_arrow {
        position: absolute;
        left: 1.8rem;
        top: 50%;
        height: .1rem;
        margin-top: -.05rem;
    }

    .mengceng {
        z-index: 66;
    }
</style>

<body>
    <div class="selectBox">
        <select class="select" name="" id="cityBox">
            <!-- <option value="1" city="北京市">华熙LIVE·北京五棵松</option>
            <option value="2" city="重庆市">华熙LIVE·重庆鱼洞</option>
            <option value="3" city="成都市">华熙LIVE·成都528艺术村</option> -->
        </select>
        <img src="weixin/membercardNew/pic/icon_address.png" class="icon_address" />
        <img src="weixin/membercardNew/pic/icon_arrow.png" class="icon_arrow" />
    </div>
    <!-- 会员卡页面start -->
    <div class="wrap" id="cardCenter" style="display:none;">
        <div class="head">
            <div class="headbg">
                <div class="headbgT">
                    <img src="weixin/membercardNew/pic/img_headsculpture.png" class="carlog" />
                    <p class="carname"><span class="carName" style="text-shadow: 0px 0px 6px rgba(0,0,0,.42);"><?php echo $res['brand_name']?></span><br><span class="title" style="text-shadow: 0px 0px 6px rgba(0,0,0,.42);"><?php echo $res['title']?></span></p>
                </div>
                <div class="carnum">
                    <div id="carnum" style="text-shadow: 0px 0px 6px rgba(0,0,0,.42);"></div>
                    <div class="cardname" style="text-shadow: 0px 0px 6px rgba(0,0,0,.42);"></div>
                </div>
                <div id="membershipGrade" class="dengjifont">
                    <p class="usepoint"><span class="usepointfont">普卡</span><img class="icon_img" src='weixin/membercardNew/pic/icon_vipnew.png' /><span class="hyqi">会员权益 ></span></p>
                </div>
            </div>
            <div class="codeImg"><img src='weixin/membercardNew/pic/icon_code.png' /></div>
        </div>

        <div class="tab" id="getCard" style="display:none;">
            <p class="carState activate">领取会员卡</p>
        </div>

        <div class="tab" id="havepoint" style="display:none;">
            <div id="nowpoint" style="margin-right:4%">
                <p style="font-size: .18rem;margin-bottom:0px;padding-left:.6rem;text-align:left;" class="nowpoint">0</p>
                <p style="font-size: .12rem;">当前积分</p>
                <img src="weixin/membercardNew/pic/icon_integral.png" style="width:.225rem;position:absolute;left:.3rem;top:.17rem" />
            </div>
            <div id="myManagement" style="padding-top: .1rem;">
                <img src="weixin/membercardNew/pic/icon_account.png" style="width:.225rem;" />
                <p style=" font-size: .12rem; color: rgb(29,29,29);margin-bottom:0px">我的管理</p>
            </div>
        </div>

        <div class="centen" style="display:none;">
            <div class="centenY">
                <div class="centenCom" id='carManage'>
                    <p class="comImg"><img src="weixin/membercardNew/pic/icon_car.png" /></p>
                    <p>停车管理</p>
                </div>
                <div class="centenCom" id="repast">
                    <p class="comImg"><img src="weixin/membercardNew/pic/icon_VIPCopy.png" /></p>
                    <p>就餐取号</p>
                </div>
                <div class="centenCom" id="selfhelp">
                    <p class="comImg"><img src="weixin/membercardNew/pic/icon_Bootstrapintegration.png" /></p>
                    <p>自助积分</p>
                </div>
            </div>
            <div class="centenY">
                <div class="centenCom" id="ticket">
                    <p class="comImg"><img src="weixin/membercardNew/pic/icon_VIP.png" /></p>
                    <p>购票</p>
                </div>
                <div class="centenCom" id="hipaly">
                    <p class="comImg"><img src="weixin/membercardNew/pic/icon_Hi.png" /></p>
                    <p>Hi玩</p>
                </div>
                <div class="centenCom" id="community">
                    <div class="comImg"><img src="weixin/membercardNew/pic/icon_community.png" /></div>
                    <p>社区</p>
                </div>
            </div>
            <div class="centenY">
                <div class="centenCom" id="market">
                    <div class="comImg" id="shopmes">
                        <img src="weixin/membercardNew/pic/icon_mall.png" />
                        <!-- <div class="shopredmes" style="display:none">CBA</div> -->
                    </div>
                    <p>商城</p>
                </div>
                <div class="centenCom" id="luckyDraw">
                    <p class="comImg"><img src="weixin/membercardNew/pic/icon_lotterydraw.png" /></p>
                    <p>抽奖活动</p>
                </div>
                <div class="centenCom" id="auction">
                    <p class="comImg"><img src="weixin/membercardNew/pic/icon_auction.png" /></p>
                    <p>竞拍</p>
                </div>
            </div>
            <!-- 新增幸运球logo -->
            <div class="luckballBox" style="display:none">
                <img src="weixin/membercardNew/pic/luckball.png" luckball=1 class="luckballIcon" />
                <img src="weixin/membercardNew/pic/flota.png" class="luckballFloatIcon" />
            </div>
        </div>

    </div>
    <!-- 会员卡页面end -->

    <!-- 领卡页面start -->
    <div class="wrap" id="cardInfo" style="padding:0px;display:none;">
        <div class="bgImgHi"></div>
        <div class="centerHi">
            <img src="weixin/membercardNew/pic/icon_logo.png" class="icon_logo" />
            <div class="haveto">手机验证</div>
            <div class="mobile">
                <p>手机号</p>
                <input type="number" placeholder="请输入手机号" class="phone" id="bmmobilenum" value="<?php echo $mobile?:''?>" <?php echo $mobile? "readonly": ""?> />
            </div>
            <?php if (!$mobile) {?>
            <div class="mobile" style="position:relative" id="getyzm">
                <p>验证码</p>
                <input type="number" placeholder="请输入手机验证码" class="phone" id="bmauthcCode" oninput="if(value.length>5)value=value.slice(0,6)" />
                <input type="button" class="getCode" value="获取验证码" id="bmgetCode" />
            </div>
            <?php }?>

            <div class="haveto" style="margin-top:.2rem">用户信息</div>

            <div class="mobile" id="nameBox">
                <p>姓名</p>
                <input type="text" placeholder="请输入姓名" id="name" />
            </div>
            <div class="mobile birthday">
                <p>性别</p>
                <select name="selecte" id="sex">
                    <option value="男">男</option>
                    <option value="女">女</option>
                </select>
            </div>
            <div class="mobile birthday">
                <p>生日</p>
                <div id="birthday"></div>
            </div>
            <div class="intr">
                <div class="checkbox" checked_="0"><img src="weixin/membercardNew/pic/selected.png" /></div>
                <p>我已阅读并同意 <span id="directionuse">会员卡信息使用说明</span></p>
            </div>

            <div class="carState activate" id="activate" act="0">提交并领取会员卡</div>
        </div>
    </div>
    <!-- 领卡页面end -->

    <div class="shezhi_tishi">
        <p></p>
    </div>

    <div class="mengceng"></div>

    <!-- 幸运球弹窗 -->
    <div class="luckball">
        <div class="luckballbigpic"><img src="weixin/membercardNew/pic/luballBif.png" /></div>
        <div class="receiveBtn">立即领取</div>
        <div class="closeluckball"><img src="weixin/membercardNew/pic/btn_close.png" /></div>
    </div>

    <div class="qiandaoxiangqing">
        <h2>每天登录可得5积分</h2>
        <div class="guocheng">
            <ul>
                <li class="jifenF">第<span class="dijitian zaidijitian">1</span>天
                    <div class="songjifen">5积分</div>
                </li>
                <li class="shuxian"></li>
                <li>第<span class="dijitian">2</span>天
                    <div class="songjifen">5积分</div>
                </li>
                <li class="shuxian"></li>
                <li>第<span class="dijitian">3</span>天
                    <div class="songjifen">5积分</div>
                </li>
                <li class="shuxian"></li>
                <li>第<span class="dijitian">4</span>天
                    <div class="songjifen">5积分</div>
                </li>
                <li class="shuxian"></li>
                <li>第<span class="dijitian">5</span>天
                    <div class="songjifen">5积分</div>
                </li>
                <li class="shuxian"></li>
                <li>第<span class="dijitian">6</span>天
                    <div class="songjifen">5积分</div>
                </li>
                <li class="shuxian"></li>
                <li>第<span class="dijitian">7</span>天
                    <div class="songjifen">5积分</div>
                </li>
            </ul>
        </div>
        <p class="lianxi7tian">连续签到7天额外赠送15积分</p>
        <p class="lianxi7tian carmiaoshu">您是<span class="memberName"></span>会员，签到可得<span class="todayBonus"></span>积分</p>
        <div class="iknow qiandaowenzi">签到</div>
        <div class="closeBtn closeqiandaoBtn">×</div>
    </div>

    <div class="ptext">
        <span class="pspan">连续签到7天</span>
        <br/>
        <span class="pnumber">+&nbsp;<span class="todayBonus">5</span>积分</span>
    </div>

    <div class="codeBox">
        <div class="codeBoxtop">
            <div class="tiaobox"><img src="" />
                <p class="tiaoboxcode"></p>
            </div>
        </div>
        <div class="codeBoxbot"><img src="" />
            <p class="codeBoxbotfont">到店出示给收银即可使用</p>
        </div>
        <div class="coloeCode"><img src="weixin/membercardNew/pic/btn_close.png" /></div>
    </div>
</body>
<script src="weixin/common/jquery.js"></script>
<script src="weixin/common/md5.js"></script>
<script src="weixin/common/common.js"></script>
<!-- 幸运球 -->
<script src="weixin/luckball/js/common.js"></script>
<script src="weixin/membercardNew/js/fontSize.js"></script>
<script src="weixin/membercardNew/js/datePicker.js"></script>
<script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script type="text/javascript" src="https://pingjs.qq.com/h5/stats.js" name="MTAH5" sid="500338441"></script>
<script charset="utf-8" src="https://map.qq.com/api/js?v=2.exp"></script>
<script>
    window.onpageshow = function(event) {
        if (event.persisted) {
            window.location.reload();
        }
    };

    var sessionLocation = <?php echo $sessionLocation?>;
    // 获取定位列表
    getcitylist();
    if (sessionLocation == false) {
        // 定位
        getCity();
    } else {
        // cityselect(sessionLocation.cityName,sessionLocation.latitude,sessionLocation.longitude);
        $("#cityBox option").each(function(i, k) {
            console.log($(k).attr('city'));
            if (sessionLocation.cityName == $(k).attr('city')) {
                $(k).prop('selected', true);
                tishi("当前城市：" + sessionLocation.cityName);
                return false;
            }
        });
    }

    function getNowFormatDate() {
        var date = new Date();
        var seperator1 = "-";
        var seperator2 = ":";
        var month = date.getMonth() + 1;
        var strDate = date.getDate();
        if (month >= 1 && month <= 9) {
            month = "0" + month;
        }
        if (strDate >= 0 && strDate <= 9) {
            strDate = "0" + strDate;
        }
        var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate + " " + date.getHours() + seperator2 + date.getMinutes() + seperator2 + date.getSeconds();
        return currentdate;
    }
    var nowdata = getNowFormatDate().slice(8, 10);
    $(".shopredmes").show();
    var appId = '<?php echo APPID?>';
    var nonceStr = '<?php echo $nonceStr;?>';
    var timestamp = '<?php echo $timestamp;?>';
    var signature = '<?php echo $signature;?>';
    var cardSignature = '<?php echo $cardSignature;?>';
    var openid = "<?php echo $openid?>";
    var unionid = "<?php echo $unionid?>";
    var uid = "<?php echo $uid?>";
    var mobile = "<?php echo $mobile?>";
    var getSMSCodeMobile = ''; // 记录获取验证码的手机号，提交时检测
    var obj = <?php echo $obj?>;
    var lastLocation = <?php echo $lastLocation?>; // 获取上一次定位信息
    var cardId = "<?php echo $res['cardId']?>";
    console.log(lastLocation)
    $("#birthday").css({
        "-webkit-tap-highlight-color": " rgba(0,0,0,0)",
        "-webkit-tap-highlight-color":   "transparent"
    })
    if (mobile != 0) { // 有手机
        $("#cardCenter").show();
        if (obj.hasCard == 1) { // 有卡
            $("#havepoint").show();
            $(".centen").show();
            // 卡信息
            $(".carName").html(obj.result.brand_name);
            $(".title").html(obj.result.title);
            $(".cardname").html(obj.result.name);
            $("#carnum").html(obj.result.code);
            // 生成一维码+二维码
            var codeImg = getCode(obj.result.code);
            var tiaoSrc = '<?php echo $tools->createBarcode(' + obj.result.code + ')?>';
            $(".tiaobox img").attr('src', tiaoSrc);
            var numcode = obj.result.code;
            var numcodeNew = numcode.substr(0, 4) + " " + numcode.substr(4, 4) + " " + numcode.substr(8, 4);
            $(".tiaoboxcode").html(numcodeNew);
            $(".codeImg").on("click", function() {
                $(".mengceng").show();
                $(".codeBox").show();
                $(".codeBoxbot img").attr('src', codeImg);
            });
            $(".coloeCode").on("click", function() {
                $(".mengceng").hide();
                $(".codeBox").hide();
            });
            // 获取积分记录
            var nowpoint = $(".nowpoint");
            getUserPointDJ(uid, nowpoint);
            // 获取已用积分
            var usepoint = $(".usepoint");
            // 签到
            qiandao(WX_URL + "requestAjax.php", uid, mobile);
            $(".closeBtn").on("click", function() {
                qiandaoxiangqing();
            });
            $(".iknow").on("click", function() {
                qiandaoxiangqing();
            });
        } else { // 无卡
            $("#getCard").show();
        }
    } else { // 无手机
        $("#cardInfo").show();
    }

    var calendar = new datePicker();
    calendar.init({
        'trigger': '#birthday',
        'type': 'date',
        'minDate': '1900-1-1',
        'maxDate': '2100-12-31',
        'onSubmit': function() { /*确认时触发事件*/
            var theSelectData = calendar.value;
            $("#birthday").html(theSelectData);
        },
        'onClose': function() { /*取消时触发事件*/ }
    });

    $("#getCard").on("click", function() {
        if (obj.result == false) {
            $("#cardCenter").hide();
            $("#cardInfo").show();
        } else {
            getWxCard();
        }
    });

    // 自助积分
    $("#selfhelp").on("click", function() {
        if ($("#cityBox option:selected").attr("city") != "北京市") {
            tishi("敬请期待！");
            return;
        }
        var cityid = $("#cityBox").val();
        window.location.href = WX_URL + "user.php?uploading=1&cityid=" + cityid;
        return;
    });
    // Hi玩
    $("#hipaly").on("click", function() {
        window.location.href = WX_URL + 'weixin/game/gamesmenu/index.html';
        return;
    });
    // 社区
    $("#community").on("click", function() {
        window.location.href = 'http://melive.huaxiweiying.com/weibei/6lo40d7ffc';
        return;
    });
    // 竞拍
    $("#auction").on("click", function() {
        // if ($("#cityBox option:selected").attr("city") != "北京市") {
        //     tishi("敬请期待！");
        //     return;
        // }
        var cityid = $("#cityBox").val();
        window.location.href = WX_URL + "weixin/game/hxauction/index.html?cityid=" + cityid;
        return;
    });
    // 商城
    $("#market").on("click", function() {
        if ($("#cityBox option:selected").attr("city") != "北京市") {
            tishi("敬请期待！");
            return;
        }
        // $(".mengceng").show();
        // onanniu('好货上架中......<br>敬请期待！', '确定');
        // $(".i_know").on("click", function() {
        //     $(".onekuang").remove();
        //     $(".mengceng").hide();
        // });
        var cityid = $("#cityBox").val();
        window.location.href = WX_URL + "user.php?shop=1&cityid=" + cityid;
        return false;
    });
    // 购票
    $("#ticket").on("click", function() {
        // tishi("敬请期待！");
        window.location.href = WX_URL + "user.php?ticketList=1";
        return;
    });
    // 就餐取号
    $("#repast").on("click", function() {
        if ($("#cityBox option:selected").attr("city") != "北京市") {
            tishi("敬请期待！");
            return;
        }
        window.location.href = WX_URL + "user.php?mwee=1";
        return;
    });
    // 车辆管理
    $("#carManage").on("click", function() {
        if ($("#cityBox option:selected").attr("city") != "北京市") {
            tishi("敬请期待！");
            return;
        }
        // $(".mengceng").show();
        // onanniu('升级维护中...', '确定');
        // $(".i_know").on("click", function() {
        //     $(".onekuang").remove();
        //     $(".mengceng").hide();
        // });
        var cityid = $("#cityBox").val();
        window.location.href = WX_URL + "user.php?onlinepayment=1&cityid=" + cityid;
        return;
    });
    // 抽奖活动
    $("#luckyDraw").on("click", function() {
        // if ($("#cityBox option:selected").attr("city") != "北京市") {
        //     tishi("敬请期待！");
        //     return;
        // }
        var cityid = $("#cityBox").val();
        window.location.href = WX_URL + "user.php?slyder=1&cityid=" + cityid;
        return;
    });
    // 当前积分
    $("#nowpoint").click(function(event) {
        window.location.href = WX_URL + "user.php?pointrecord=1";
        return;
    });
    // 会员等级
    $("#membershipGrade").click(function(event) {
        window.location.href = WX_URL + "/weixin/membercardNew/memberqy.html?uid=" + uid;
        return;
    });
    // 我的管理
    $("#myManagement").click(function(event) {
        window.location.href = WX_URL + "user.php?myManagement=1";
        return;
    });

    $("#directionuse").on("click", function() {
        window.location.href = WX_URL + "/weixin/membercardNew/directionuse.html";
    })

    $(".checkbox").click(function(event) {
        if ($(this).attr("checked_") == "1") {
            $(this).attr("checked_", "0");
            $(this).find("img").attr("src", "/weixin/membercardNew/pic/selected.png");
            $(".carState").removeClass('noactivate');
            $(".carState").addClass('activate');
            $(".carState").attr("act", "0");
        } else if ($(this).attr("checked_") == "0") {
            $(this).attr("checked_", "1");
            $(this).find("img").attr("src", "/weixin/membercardNew/pic/selected_1.png");
            $(".carState").removeClass('activate');
            $(".carState").addClass('noactivate');
            $(".carState").attr("act", "1");
        }
    });

    // 绑定手机+领取微信会员卡
    $("#activate").on("click", function() {
        if ($(this).attr('act') == '0') {
            var arr = {};
            arr.uid = uid;
            arr.cardId = cardId;
            arr.openid = openid;
            arr.mobile = $("#bmmobilenum").val();
            arr.name = $("#name").val().trim();
            arr.sex = $("#sex").val();
            arr.birthday = $("#birthday").html();
            arr.cityId = "<?php echo $cityId?>"==''?1:"<?php echo $cityId?>";
            if (!(/^1\d{10}$/.test(arr.mobile))) {
                tishi("请填写正确的手机号码");
                return false;
            }
            if (arr.name == "" || arr.birthday == "") {
                tishi("请完善信息！");
                return false;
            }
            if ($("#getyzm").length > 0) {
                if (getSMSCodeMobile == '') {
                    tishi("请使用本机获取验证码");
                    return false;
                }
                var mobile_number = $("#bmmobilenum").val();
                var mobile_number_peo = $("#bmauthcCode").val();
                var yzm = checkMobileAndSMSCode(mobile_number, mobile_number_peo);
                if (!yzm || (getSMSCodeMobile != mobile_number)) {
                    tishi("手机号或验证码错误")
                    return false;
                }
                var result = bindMobile(mobile_number, mobile_number_peo, openid, unionid);
                if (result.state != 0) {
                    tishi("绑定手机失败");
                    return false;
                }
                arr.uid = result.result.uid;
                mobile = result.result.mobile;
                tishi('绑定成功！');
                $(".bindmobile").hide();
                $(".trackmatte").remove();
            }
            storageCardInfo(arr);
        } else {
            return false;
        }
    });

    //绑定手机号  获取验证码
    $("#bmgetCode").on("click", function() {
        var get_code = $("#bmgetCode");
        getSMSCodeMobile = $("#bmmobilenum").val();
        getyzm(getSMSCodeMobile, get_code);
    })

    // 会员卡信息入库
    function storageCardInfo(arr) {
        $.ajax({
            url: WX_URL + 'requestAjax.php',
            type: 'POST',
            dataType: 'json',
            data: {
                dataArr: arr,
                identity: 'getMemberCard'
            },
            success: function(data) {
                console.log(data);
                getWxCard();
            },
            error: function(data) {
                console.log(data);
            }
        });
    }

    // 领取微信会员卡
    function getWxCard() {
        wx.config({
            debug: false,
            appId: appId,
            timestamp: timestamp,
            nonceStr: nonceStr,
            signature: signature,
            jsApiList: ['checkJsApi', 'addCard']
        });
        wx.ready(function() {
            wx.checkJsApi({
                jsApiList: ['addCard'],
                success: function(res) {
                    // console.log(res);
                }
            });
            wx.addCard({
                cardList: [{
                    cardId: cardId,
                    cardExt: '{"nonce_str":"' + nonceStr + '", "timestamp": "' + timestamp + '", "signature":"' + cardSignature + '"}'
                }],
                success: function(res) {
                    // console.log(res.cardList);
                    window.location.reload();
                },
                cancel: function(res) {
                    // console.log(res);
                    window.location.reload();
                },
                fail: function(res) {
                    // console.log(res);
                }
            });
        });
        wx.error(function(res) {
            // console.log(res);
        });
    }

     function setMemberCardFalg() {
         $.ajax({
             url: WX_URL + 'requestAjax.php',
             type: 'POST',
             dataType: 'json',
             data: {
                 uid: uid,
                 mobile: mobile,
                 identity: 'setMemberCardFalg'
             },
             success: function(data) {
                 console.log(data);
             },
             error: function(data) {
                 console.log(data);
             }
         });
     }
    /*提示框 一个按钮的*/
    function onanniu(centen_wenzi, anniu_wenzi) {
        var tishikuang_html =
            "<div style='width: 80%;position: fixed;background: #ffffff; border-radius: 0.04rem; left: 10%;top: 1.2rem;z-index:9999' class='onekuang'><div style='padding-bottom: 0.36rem;padding-top: 0.4rem;text-align: center;border-bottom: 1px solid rgb(230,230,203);color: rgb(51,51,51);font-size: 0.16rem;'>" +
            centen_wenzi +
            "</div><div style='margin:0.2rem 0 ;width: 80%;margin-left: 10%;height: 0.4rem;background: rgb(255,221,16);border-radius: 0.2rem;font-size: 0.16rem;color: rgb(51,51,51);text-align: center;line-height: 0.4rem;' class='i_know'>" +
            anniu_wenzi + "</div></div>";
        $("body").append(tishikuang_html);
    }

    /**获取 会员卡 等级*/
    function getUserPointDJ(uid, userPoint) {
        var point = "";
        $.ajax({
            url: WX_URL + 'requestAjax.php',
            type: 'POST',
            dataType: 'json',
            async: false,
            data: {
                'uid': uid,
                'identity': 'getUserPoint'
            },
            success: function(res) {
                console.log(res);
                if (userPoint != "") {
                    userPoint.text(res.result.point);
                }
                point = res.result.point;
                var addclass = '';
                var hyqion = '';
                var cardLevel = res.result.memberName;
                // var cardLevel = "钻石卡";
                if (cardLevel == "普卡") {
                    addclass = "colorp";
                    hyqion = "hyqipk";
                } else if (cardLevel == "银卡") {
                    addclass = "colory";
                    hyqion = "hyqiyk";
                } else if (cardLevel == "金卡") {
                    addclass = "colorj";
                    hyqion = "hyqijk";
                } else if (cardLevel == "黑卡") {
                    addclass = "colorh";
                    hyqion = "hyqihk";
                } else if (cardLevel == "钻石卡") {
                    addclass = "colorz";
                    hyqion = "hyqizsk";
                };
                $(".usepoint").addClass(addclass);
                $(".hyqi").addClass(hyqion);
                $(".usepointfont").html(res.result.memberName);
            },
            error: function(res) {
                console.log(res);
            }
        });
        return point;
    }

    if ($("#cityBox option:selected").attr("city") == "北京市") {
        $(".luckballBox").show();
    }
    // 幸运球 logo
    var logonTop = $(".head").height() + $(".tab").height() - 10;
    if ($(".centen").css("display") != "none") {
        $(".selectBox").show();
    }
    if ($(".selectBox").css("display") != "none") {
        logonTop = $(".head").height() + $(".tab").height() + 24;
    }
    $(".luckballBox").css("top", logonTop + "px");
    $(".luckballIcon").on("click", function() {
        $(".luckballIcon").css({
            "-webkit-tap-highlight-color": "rgba(0,0,0,0)"
        })
        if ($(this).attr("luckball") == 1) {
            // 点击球进入详情页
            window.location.href = WX_URL + "user.php?luckballact=1";
            return false;
        } else if ($(this).attr("luckball") == 0) {
            // 显示
            $(".luckballIcon").attr('luckball', 1);
            $(".luckballIcon").css({
                "right": ".03rem",
                "-webkit-transition": " right .5s"
            })
            $(".luckballFloatIcon").css({
                "left": "-.3rem",
                "-webkit-transition": " left .5s"
            })
        }
    });
    $(".luckballFloatIcon").on("click", function() {
        // 隐藏
        $(".luckballIcon").attr('luckball', 0);
        $(".luckballIcon").css({
            "right": "-.3rem",
            "-webkit-transition": " right .5s"
        })
        $(".luckballFloatIcon").css({
            "left": ".43rem",
            "-webkit-transition": " left .5s"
        });
    })

    // 获取定位列表
    function getcitylist() {
        $.ajax({
            type: "get",
            url: COUPON_URL + "api/api/getCityList",
            async: false,
            dataType: "json",
            data: createSign(),
            success: function(data) {
                console.log(data);
                var optionHtml = '';
                $.each(data.result, function(i, k) {
                    optionHtml += '<option value="' + k.cityid + '" city="' + k.cityname + '">' + k.desc + '</option>'
                });
                $("#cityBox").html(optionHtml);
            },
            error: function() {
                console.log("error");
            }
        });
    }

    // 定位
    function getCity() {
        <?php echo $jsapi?>
        wx.ready(function() {
            wx.checkJsApi({
                jsApiList: ['getLocation'],
                success: function(res) {}
            });
            wx.getLocation({
                type: 'wgs84', // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
                success: function(res) {
                    console.log(res);
                    var latitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90
                    var longitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。
                    var speed = res.speed; // 速度，以米/每秒计
                    var accuracy = res.accuracy; // 位置精度
                    // 地址解析:https://lbs.qq.com/javascript_v2/guide-service.html#link-four
                    var geocoder = new qq.maps.Geocoder({
                        complete: function(result) {
                            // alert(result.detail.addressComponents.city)
                            cityselect(result.detail.addressComponents.city, latitude, longitude);
                        }
                    })
                    var coord = new qq.maps.LatLng(res.latitude, res.longitude)
                    geocoder.getAddress(coord);
                },
                cancel: function(res) {
                    // alert('用户拒绝授权获取地理位置');
                    var locationarr = {
                        "cityId": 1,
                        "cityName": "北京市",
                        "openid": openid
                    };
                    sessionLocationFun(locationarr);
                }
            });
        })
    }

    function cityselect(city, latitude, longitude) {
        tishi("当前城市:" + city);
        // if (city != lastLocation.cityName) {
        // }
        var locationarr = {
            "cityId": "1",
            "cityName": city,
            "openid": openid,
            "latitude": latitude,
            "longitude": longitude
        };
        storeUserLocation(locationarr);
        sessionLocationFun(locationarr);
        $("#cityBox option").each(function(i, k) {
            console.log($(k).attr('city'));
            if (city == $(k).attr('city')) {
                $(k).prop('selected', true);
                return false;
            }
        });
    }

    function storeUserLocation(locationarr) {
        $.ajax({
            url: WX_URL + 'requestAjax.php',
            type: 'POST',
            dataType: 'json',
            async: false,
            data: {
                "location": locationarr,
                'identity': 'storeUserLocation'
            },
            success: function(res) {
                console.log(res)
            },
            error: function() {}
        })
    }

    // 将定位信息存入 session
    function sessionLocationFun(locationarr) {
        $.ajax({
            url: WX_URL + 'requestAjax.php',
            type: 'POST',
            dataType: 'json',
            async: false,
            data: {
                "location": locationarr,
                'identity': 'sessionLocation'
            },
            success: function(res) {
                console.log(res)
            },
            error: function() {}
        })
    }
    // 幸运球弹窗
    // 关闭弹窗
    $(".closeluckball").on("click", function() {
            $(".luckball").hide();
            $(".mengceng").hide();
        })
        // 立即领取
    $(".receiveBtn").on("click", function() {
        $(".luckball").hide();
        $(".mengceng").hide();
        // 点击球进入详情页
        window.location.href = WX_URL + "user.php?luckballact=1";
    })


    //切换城市中
    $("#cityBox").change(function(event) {
        tishi("切换城市中....");
        var locationarr = {
            "cityId": $(this).val(),
            "cityName": $("#cityBox option:selected").attr("city"),
            "openid": openid
        };
        if ($("#cityBox option:selected").attr("city") == "北京市") {
            $(".luckballBox").show();
        } else {
            $(".luckballBox").hide();
        }
        sessionLocationFun(locationarr);
    });

    if ($(".qiandaoxiangqing").css("display") == "none") {
        console.log("require_isBarraged");
        if ($("#cityBox option:selected").attr("city") == "北京市" && obj.result) {
            // 判断是否有选号活动
            console.log("require_isBarraged北京市");
            require_isBarraged(uid);
        }
    }
    // 判断是否有选号活动
    function require_isBarraged(uid) {
        var sendUrl = APP_URL + 'HXXCLuckyBall/ball/require_isBarraged.json';
        var sendDate = JSON.stringify({
            "uid": uid
        });
        javaFnAjax(sendUrl, sendDate, function(data) {
            console.log(data);
            //显示弹屏
            if (data.state == 0) {
                $(".luckball").show();
                $(".mengceng").show();
            }
        }, function() {
            console.log("error")
        });
    }
    // 微信分享
      var share={"shareTitle":"吃喝玩乐 华熙LIVE一卡通","shareDesc":"会员积分免费停车","posterImage":WX_URL+"tmp/title.png"};
     // 微信分享给朋友
      <?php echo $jsapi?>
      wx.error(function(res) {
          console.log("出错了：");
          console.log(res.errMsg);
      });
      wx.ready(function() {
          wx.checkJsApi({
              jsApiList: ['onMenuShareAppMessage','onMenuShareTimeline'],
              success: function(res) {}
          });
          // 分享给朋友
          wx.onMenuShareAppMessage({
              title: share.shareTitle,
              desc: share.shareDesc,
              link: WX_URL + "user.php",
              imgUrl:  share.posterImage,
              trigger: function(res) {
                  // 用户确认分享后执行的回调函数
              },
              success: function(res) {
                  // 用户确认分享后执行的回调函数
              },
              cancel: function(res) {
                  console.log("取消分享：");
                  console.log(JSON.stringify(res));
                  // 用户取消分享后执行的回调函数
              },
              fail: function(res) {
                  console.log("分享失败：");
                  console.log(JSON.stringify(res));
              }
          });
          // 分享到朋友圈
          wx.onMenuShareTimeline({
              title: share.shareTitle,
              desc: share.shareDesc,
              link: WX_URL + "user.php",
              imgUrl:  share.posterImage,
              trigger: function(res) {
                  // 用户确认分享后执行的回调函数
              },
              success: function(res) {
                  // 用户确认分享后执行的回调函数
              },
              cancel: function(res) {
                  console.log("取消分享：");
                  console.log(JSON.stringify(res));
                  // 用户取消分享后执行的回调函数
              },
              fail: function(res) {
                  console.log("分享失败：");
                  console.log(JSON.stringify(res));
              }
          });
          console.log('已注册获取“发送给朋友”状态事件');
      })
</script>

</html>
