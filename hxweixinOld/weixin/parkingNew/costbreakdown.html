<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="format-detection" content="telephone=no" />
    <meta name="format-detection" content="email=no" />
    <!--禁止页面缩放-->
    <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" id="viewport" name="viewport">
    <title>费用明细</title>
    <link rel="stylesheet" type="text/css" href="weixin/parkingNew/css/lc_switch.css" />
    <link rel="stylesheet" type="text/css" href="weixin/parkingNew/css/costbreakdown.css" />
</head>
<style>
    .carnum {
        /*background: #fff;*/
    }

    .bgc {
        background: rgb(230, 230, 230);
        width: 100%;
        height: .1rem;
    }

    /* 付款成功*/
    .paysuccess {
        width: 100%;
        position: fixed;
        left: 0;
        bottom: -4rem;
        z-index: 30;
        background: rgb(255, 255, 255) !important;
    }

    .pstitle {
        width: 100%;
        height: .38rem;
        line-height: .38rem;
        background: rgb(255, 255, 255) !important;
        text-align: center;
        position: relative;
    }

    .colsePay {
        position: absolute;
        left: .14rem;
        top: 0;
    }

    .psimg {
        width: 20%;
        margin-left: 40%;
        margin-top: .285rem;
    }

    .psmes {
        text-align: center;
        font-size: .18rem;
        color: rgb(51, 51, 51);
        margin-bottom: .1rem;
    }

    .pspoint {
        text-align: center;
        font-size: .18rem;
        color: rgb(233, 6, 78);
        margin-bottom: .68rem;
    }

    .bgimg {
        position: absolute;
        left:0;
        top: -.4rem;
        border-radius: .28rem;
        height: .53rem;
        box-shadow: 0px 1px 7px 0px rgba(0,0,0,.08);
        background: #fff;
        line-height: .53rem;
        padding-left: .68rem;
        padding-right: .25rem
    }
   .bgimg img{
       position: absolute;
       left: .3rem;
       top: .13rem;
       width: .3rem;
   }
    .bgh {
        position: absolute;
        left: 0px;
        top: -.0rem;
        width: 100%;
        height: .05rem;
        background: url(weixin/parkingNew/pic/img_line.png) no-repeat;
        background-size: 100% 100%;
    }

    .mesfont {
        font-size: .14rem;
        color: rgb(185, 185, 185);
        margin:.25rem .21rem .1rem .21rem;
    }
</style>

<body>
    <div class="wrap">
        <div class="centen">
            <div class="bgimg">
                <img src="weixin/parkingNew/picnew/icon_plate_number.png"/>
                <div class="carnum"></div>
            </div>
            <div class="clist">
                <p>入场时间</p>
                <p id="inDt"></p>
            </div>
            <div class="clist">
                <p>停车时长</p>
                <p id="ParkTime"></p>
            </div>
            <div class="clist">
                <p>收费标准</p>
                <p id="chargeRule"></p>
            </div>

            <div class="clist">
                <p>停车费用</p>
                <p id="unPayAmount">￥0</p>
            </div>
            <div class="clist">
                <p>会员优惠金额</p>
                <p id="freeMinsAmount">￥0</p>
            </div>
            <div class="clist">
                <p>消耗积分</p>
                <p id="deductPoint">0</p>
            </div>
            <div class="clist" style="border-top:1px dashed #F1F1F1">
                <p></p>
                <p><span style="margin-right:.16rem">实付费用</span><span class="total" id="decuctAmount">￥0</span></p>
            </div>
            <!-- <div class="clist">
                <p>费用合计</p>
                <p class="total" id="totalAmount">￥0</p>
            </div> -->
        </div>
        <div class="mesfont">如当天已享受过会员减免或积分不足，则无法享受优惠。</div>
        <div class="wxshow">
            温馨提示：付款成功后，需在<span id="freeOutTime">15</span>分钟内驶离车场，否则需要补缴超时费用。
        </div>
        <div class="footer" clickStyle="true"><img src="weixin/parkingNew/picnew/btn_confirm_payment.png"/></div>
    </div>
    <div class="trackMatte"></div>

    <div class="paysuccess">
        <div class="pstitle">
            付款结果
            <div class="colsePay">关闭</div>
        </div>
        <img src="weixin/parkingNew/picnew/icon_success.png" class="psimg" />
        <p class="psmes">您的付款已成功</p>
        <p class="pspoint">赠送积分：+<span id="zengPoint"></span></p>
    </div>
    <!-- 菊花加载 -->
    <div id="foo" style="position:absolute;left:49%;top:40%;display:none"></div>
</body>
<script src="weixin/common/jquery.js"></script>
<script src="weixin/common/fontSize.js"></script>
<script src="weixin/common/common.js"></script>
<script src="weixin/common/md5.js"></script>
<script src="weixin/parkingNew/js/common.js"></script>
<!-- 菊花加载 -->
<script src="weixin/common/spin.min.js"></script>
<script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script type="text/javascript" src="https://pingjs.qq.com/h5/stats.js" name="MTAH5" sid="500338441"></script>
<script>
    //修改 。36  。1
    function twoanniu(centen_wenzi, anniu_wenzi, anniu_wenziR) {
        var tishikuang_html = "<div style='width: 90%;position: fixed;background: #ffffff; border-radius: 0.04rem; left: 5%;top: 0.69rem;z-index:50'>" +
            "<div style='padding-bottom: 0.3rem;padding-top: 0.2rem;text-align: center;border-bottom: 1px solid rgb(230,230,203);color: rgb(51,51,51);font-size: 0.16rem;'>" + centen_wenzi +
            "<div style='margin:0.2rem 0 ;width: 80%;height: 0.4rem;border-radius: 0.2rem;font-size: 0.16rem;color: rgb(51,51,51);'><input  val='' type='text' style='width:100%;height:100%;margin-left:10%;padding-left:.1rem;font-size:.15rem;' placeholder='请填写车牌号' /><p style='width:3rem;font-size:.14rem;color:rgb(185,185,185);margin:.06rem .14rem .24rem .2rem'>友情提示：您可以在个人中心进行车辆管理。</p></div></div>" +

            "<div style='margin:0.2rem 0 ;width: 40%;float:left;margin-left: 7%;height: 0.4rem;border:1px solid rgb(255,221,16);border-radius: 0.2rem;font-size: 0.16rem;color: rgb(51,51,51);text-align: center;line-height: 0.4rem;'>" + anniu_wenzi +
            "</div>" +

            "<div style='margin:0.2rem 0 ;width: 40%;margin-right: 7%;height: 0.4rem;background: rgb(255,221,16);border-radius: 0.2rem;font-size: 0.16rem;color: rgb(51,51,51);text-align: center;line-height: 0.4rem; float:right;'>" + anniu_wenziR +
            "</div></div>";
        $("body").append(tishikuang_html)
    }

    function twoanniu_mes(centen_wenzi, anniu_wenzir) {
        var tishikuang_html =
            "<div style='width: 80%;position: fixed;background: #ffffff; border-radius: 0.04rem; left: 10%;top: 0.69rem;z-index:50' id='twoanniu_mes'><div style='padding-top: 0.2rem;text-align: center;border-bottom: 1px solid rgb(230,230,203);font-size: 0.16rem;' id='delBox'>" +
            "<p style='color: rgb(51,51,51);padding:.07rem .15rem .2rem .15rem'>" + centen_wenzi + "</p>" +
            "</div><div style='margin:0.2rem 0 ;width: 60%;margin-right:20%;height: 0.4rem;background: rgb(255,221,16);border-radius: 0.2rem;font-size: 0.16rem;color: rgb(51,51,51);text-align: center;line-height: 0.4rem; float:right;' id='delTrue'>" +
            anniu_wenzir +
            "</div></div>";
        $("body").append(tishikuang_html)
    }

    var carNum = "<?php echo $carNum?>";
    var openId = "<?php echo $openid?>";
    var uid = "<?php echo $uid?>";
    var cityid = "<?php echo $cityid?>";
    var orderState = '';
    var parkAmount = '';
    var tradeId = '';
    var decuctAmount_ = '';


    var sendUrl=WX_URL + 'requestAjax.php';
    var sendDate={
        uid: uid,
        carNum: carNum,
        cityid: cityid,
        identity: "getCostInfo"
    };
    fnAjaxParking ('post',sendUrl,false,sendDate, function(data){
          if(data.state==0){
              var ParkTime = data.result.carsInParking.parkTime;
              orderState = data.result.carsInParking.orderState;
              var ParkTimeNew = ParkTime.replace(/:/g, "小时") + "分钟";
              // parkAmount = data.result.carsInParking.unPayAmount;
              parkAmount = data.result.carsInParking.decuctAmount;
              if (parseFloat(parkAmount) == 0) {
                  $(".footer").hide();
                  $(".wxshow").hide();
              }
              tradeId = data.result.carsInParking.tradeId;
              $(".carnum").html(data.result.carsInParking.carNumber);
              $("#inDt").html(data.result.carsInParking.inDt);
              $("#ParkTime").html(ParkTimeNew);
              // 收费标准
              $("#chargeRule").html(data.result.carsInParking.chargeRule);
              $("#unPayAmount").html("￥" + data.result.carsInParking.unPayAmount);
              $("#freeMinsAmount").html("-￥" + data.result.carsInParking.freeMinsAmount);
              $("#deductPoint").html("-" + data.result.carsInParking.deductPoint);
              $("#decuctAmount").html("￥" + data.result.carsInParking.decuctAmount);
              decuctAmount_=data.result.carsInParking.decuctAmount;
              console.log(freeOutTime(data.result.carsInParking.parkId))
              $("#freeOutTime").html(freeOutTime(data.result.carsInParking.parkId).freeOutTime);
          }
      }, function(data){
          console.log("获取在场停车信息 错误");
          console.log(data);
      });


    if (orderState == null) {
        window.history.go(-1);
    }
  var cityidInt=parseInt(cityid);
    $(".footer").on("click", function(){
        if($(this).attr("clickStyle")=="true"){
            $(this).attr("clickStyle","false");
            // $("#foo").show();
            $(this).html('<img src="weixin/parkingNew/picnew/btn_confirm_payment_gray.png"/>');
            // return false;
            if (orderState == null) {
                window.history.go(-1);
            } else {
                var sendDate={
                    uid: uid,
                    carNum: carNum,
                    cityId:cityidInt,
                    parkAmount: parkAmount,
                    // parkAmount: '0.01',
                    openId: openId,
                    tradeId: tradeId,
                    identity: "getParkingPaySign"
                };
                // alert(cityid);
                fnAjaxParking ('post',sendUrl,false,sendDate, function(data){
                    // alert( "getParkingPaySign");
                    // alert(JSON.stringify(data));
                    // return false;
                      if(data.state==0){
                          if (parseInt(data.state)  != 0) {
                              $(".trackMatte").show();
                              twoanniu_mes("当前费用已发生变化，<br>请重新支付!", "确定");
                              $("#delTrue").on("click", function() {
                                  $(".trackMatte").hide();
                                  $("#twoanniu_mes").remove();
                                  window.location.reload();
                              })
                          }
                          var jsonobj = {};
                          jsonobj.appId = data.appId;
                          jsonobj.nonceStr = data.nonceStr;
                          jsonobj.package = data.package;
                          jsonobj.paySign = data.paySign;
                          jsonobj.signType = data.signType;
                          jsonobj.timeStamp = data.timeStamp;
                          parkingPay(jsonobj);
                      }else{
                          $(".footer").attr("clickStyle","true");
                          // $("#foo").show();
                          $(".footer").html('<img src="weixin/parkingNew/picnew/btn_confirm_payment.png"/>');
                      }
                  }, function(data){
                      console.log("获取在场停车信息 错误");
                      console.log(data);
                      $(".footer").attr("clickStyle","true");
                      // $("#foo").show();
                      $(".footer").html('<img src="weixin/parkingNew/picnew/btn_confirm_payment.png"/>');
                  });
             }
       }
    })

    //调用微信JS api 支付
    function jsApiCall(data) {
        WeixinJSBridge.invoke(
            'getBrandWCPayRequest',
            data,
            function(res) {
                // alert(res.err_msg);
                WeixinJSBridge.log(res.err_msg);
                // alert(res.err_code + res.err_desc + res.err_msg);
                // 使用以上方式判断前端返回,微信团队郑重提示：
                // res.err_msg将在用户支付成功后返回ok，但并不保证它绝对可靠。
                if (res.err_msg == "get_brand_wcpay_request:ok") {
                    // 支付成功
                    // alert("支付成功");
                    $(".trackMatte").show();
                    $(".paysuccess").css("bottom", "0rem");

                    $.ajax({
                        url: WX_URL + 'requestAjax.php',
                        type: 'post',
                        dataType: 'json',
                        async: false,
                        data: {
                            uid: uid,
                            identity: "getMemberRate"
                        },
                        success: function(data) {
                            var memberRate=data.result.memberRate;
                            console.log(decuctAmount_);
                            // var newpoint=memberRate*10000*decuctAmount_/10000;
                            var newpoint=accMul(memberRate,decuctAmount_);
                            $("#zengPoint").html(parseInt(newpoint));
                        },
                        error: function(e) {
                            alert(e);
                            $(".footer").attr("clickStyle","true");
                            // $("#foo").show();
                            $(".footer").html('<img src="weixin/parkingNew/picnew/btn_confirm_payment.png"/>');
                        }
                    })

                    setTimeout(function() {
                        window.location.href = WX_URL + "user.php?onlinepayment=1&cityid=" + cityid;
                    }, 2000)

                } else { // 支付失败 注:get_brand_wcpay_request:cancel或者get_brand_wcpay_request:fail可以统一处理为用户遇到错误或者主动放弃，不必细化区分
                    // alert("支付失败")
                    window.location.reload();
                }
            }
        );
    }

    function parkingPay(data) {
        if (typeof WeixinJSBridge == "undefined") {
            if (document.addEventListener) {
                document.addEventListener('WeixinJSBridgeReady', jsApiCall, false);
            } else if (document.attachEvent) {
                document.attachEvent('WeixinJSBridgeReady', jsApiCall);
                document.attachEvent('onWeixinJSBridgeReady', jsApiCall);
            }
        } else {
            jsApiCall(data);
        }
    };

    $(".colsePay").on("click", function() {
        $(".trackMatte").hide();
        $(".paysuccess").css("bottom", "-4rem");
    })

    var appId = '<?php echo APPID?>';
    var nonceStr = '<?php echo $nonceStr;?>';
    var timestamp = '<?php echo $timestamp;?>';
    var signature = '<?php echo $signature;?>';
    // 微信分享
    wx.config({
        debug: false,
        appId: appId,
        timestamp: timestamp,
        nonceStr: nonceStr,
        signature: signature,
        jsApiList: ['checkJsApi', 'onMenuShareAppMessage']
    });
    wx.ready(function() {
        wx.checkJsApi({
            jsApiList: ['onMenuShareAppMessage'],
            success: function(res) {
                console.log(res);
            }
        });
        wx.onMenuShareAppMessage({
            title: '吃喝玩乐 华熙LIVE一卡通', // 分享标题
            desc: '会员停车，不花钱！', // 分享描述
            link: WX_URL + 'user.php?parkingnew', // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
            imgUrl: WX_URL + 'tmp/title.png', // 分享图标
            type: '', // 分享类型,music、video或link，不填默认为link
            dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
            success: function() {
                // 用户确认分享后执行的回调函数
                console.log("分享成功");
            },
            cancel: function() {
                // 用户取消分享后执行的回调函数
                console.log("取消分享");
            }
        });
    });
    wx.error(function(res) {
        // console.log(res);
    });


    //orderState
    //说明：javascript的乘法结果会有误差，在两个浮点数相乘的时候会比较明显。这个函数返回较为 精确的乘法结果。
    //调用：accMul(arg1,arg2)
    //返回值：arg1乘以arg2的精确结果
    function accMul(arg1,arg2){
        var m=0,s1=arg1.toString(),s2=arg2.toString();
        try{m+=s1.split(".")[1].length}catch(e){}
        try{m+=s2.split(".")[1].length}catch(e){}
        return Number(s1.replace(".",""))*Number(s2.replace(".",""))/Math.pow(10,m)
    }

    // 菊花加载
    $(function(){
        var opts = {
            lines: 9, // The number of lines to draw
            length: 0, // The length of each line
            width: 10, // The line thickness
            radius: 15, // The radius of the inner circle
            corners: 1, // Corner roundness (0..1)
            rotate: 0, // The rotation offset
            color: '#000', // #rgb or #rrggbb
            speed: 1, // Rounds per second
            trail: 60, // Afterglow percentage
            shadow: false, // Whether to render a shadow
            hwaccel: false, // Whether to use hardware acceleration
            className: 'spinner', // The CSS class to assign to the spinner
            zIndex: 2e9, // The z-index (defaults to 2000000000)
            top: 'auto', // Top position relative to parent in px
            left: 'auto' // Left position relative to parent in px
        };
        var target = document.getElementById('foo');
        var spinner = new Spinner(opts).spin(target);
    })
</script>

</html>
