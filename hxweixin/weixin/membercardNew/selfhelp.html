<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="format-detection" content="telephone=no" />
    <meta name="format-detection" content="email=no" />
    <!--禁止页面缩放-->
    <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" id="viewport" name="viewport">
    <title>自助积分</title>
    <link rel="stylesheet" type="text/css" href="weixin/common/common.css" />
    <link rel="stylesheet" type="text/css" href="weixin/membercardNew/css/selfhelp.css" />
</head>
<style>
    #div1 {
        position: relative;
    }

    .parkingImg {
        position: absolute;
        left: 20%;
        top: 50%;
        margin-top: -.075rem;
        height: .15rem;
    }

    .img_wrap {
        width: 94%;
        margin-left: 3%;
    }
</style>

<body>
    <div class="wrap">

        <div class="takePicture">
            <p class="takePictureH">积分方式</p>
            <div class="illustrate">
                <p>1、结账时，请直接到商家前台，告知收银员进行增加积分的操作（小票当天有效）；</p>
                <p>2、凭消费小票至hi-up客服中心，请客服人员操作增加积分（小票当天有效）；</p>
                <p>3、在本页面，拍照上传消费小票，自助积分（可上传3日内小票）；</p>
            </div>
            <img class="img_wrap" src="" alt="" style="display:none;">
            <div class="uploading" id="div1">拍小票上传<img src="weixin/membercardNew/pic/icon_cinema.png" class="parkingImg" /></div>
            <div class="uploading uploadingTrue" id="div2">
                <p id="reCamera">重拍</p>
                <p id="reUploading" state="1">确认上传</p>
            </div>
        </div>

        <div class="takePicture">
            <p class="takePictureH">拍照自助积分</p>
            <div class="illustrate">
                <p>1. 您可上传3日内的消费小票（包含消费当天），每张小票仅能参与1次积分。</p>
                <p>2. 请将小票保持平整，至少要拍完整下图红框中内容，并保证照片清晰。</p>
                <p>3. 上传成功后，我们将在7个工作日内帮您完成积分，在此期间请您保留小票以便核对。</p>
            </div>
            <div class="statement">

                <div id="example">
                    <p class="statementH">***************结账单***************</p>

                    <p class="statementH"><span class="borR">商户名</span></p>
                    <div class="statementC">
                        <p><span class="borR">结账时间：2016-05-31 12:00:21</span></p>
                        <p><span class="borR">交易号：121457812157821</span></p>
                    </div>

                    <div class="commodityBox">
                        <div class="commoditylist">
                            <div class="commoditylistPs">
                                <p>商品</p>
                                <p>数量</p>
                                <p>金额</p>
                            </div>
                            <p>======================================================================</p>
                        </div>
                        <p class="subtotal">小计：99</p>
                    </div>

                    <div class="money"><span class="borR">应收：99</span></div>

                </div>
            </div>

            <!-- <div class="uploading" id="div1">拍小票上传</div>
            <div class="uploading uploadingTrue" id="div2">
                <p id="reCamera">重拍</p>
                <p id="reUploading" state="1">确认上传</p>
            </div> -->
        </div>

        <input id="upload" type="file" accept="image/*" style="display:none;" />

        <div class="pointrecord">
            <p class="pointrecordH">自助积分记录</p>
            <div class="recordBox">
                <p class="norecord">暂无数据</p>
                <!-- <div class="recordList">
                    <div>
                        <p class="zpoint">自助积分（2017-08-07）</p>
                        <p class="state stateR">审核中</p>
                    </div>
                    <div class="check">
                        <p class="needpoint">本次积分：0</p>
                        <p class="seedetails">查看详情 〉〉</p>
                    </div>
                </div>
                <div class="recordList">
                    <div>
                        <p class="zpoint">自助积分（2017-08-07）</p>
                        <p class="state stateG">审核中</p>
                    </div>
                    <div>
                        <p class="needpoint">本次积分：0</p>
                        <p class="seedetails">查看详情 〉〉</p>
                    </div>
                </div> -->
            </div>
        </div>
    </div>

    <div class="shezhi_tishi">
        <p></p>
    </div>
    <script src="weixin/membercardNew/js/jquery-1.8.2.min.js"></script>
    <script src="weixin/membercardNew/js/fontSize.js"></script>
    <script src="weixin/common/md5.js"></script>
    <script src="weixin/common/common.js"></script>
    <script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script type="text/javascript" src="https://pingjs.qq.com/h5/stats.js" name="MTAH5" sid="500338441"></script>
    <script>
        var uid = "<?php echo $uid?>";
        var mobile = "<?php echo $mobile?>";
        var cityid = "<?php echo $cityid?>";
        var u = navigator.userAgent,
            app = navigator.appVersion;
        var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Linux') > -1; // android终端或者uc浏览器
        var isiOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); // ios终端

        // if(isAndroid){
        //     $("#upload").attr('capture','camera');
        // }

        var dataUrl = null;
        $(".check").on("click", function() {
            window.location.href = "selfhelpdetails.html";
        })

        var demo_h5_upload_ops = {
            init: function() {
                this.eventBind();
            },
            eventBind: function() {
                var that = this;
                $("#upload").change(function() {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        that.compress(this.result);
                    };
                    reader.readAsDataURL(this.files[0]);
                });
            },
            compress: function(res) {
                var that = this;
                var img = new Image(),
                    maxH = 600;

                img.onload = function() {
                    var cvs = document.createElement('canvas'),
                        ctx = cvs.getContext('2d');

                    if (img.height > maxH) {
                        img.width *= maxH / img.height;
                        img.height = maxH;
                    }
                    cvs.width = img.width;
                    cvs.height = img.height;

                    ctx.clearRect(0, 0, cvs.width, cvs.height);
                    ctx.drawImage(img, 0, 0, img.width, img.height);
                    dataUrl = cvs.toDataURL('image/jpeg', 1);
                    $(".img_wrap").attr("src", dataUrl);
                    $("#div1").hide();
                    $("#div2").show();
                    $(".img_wrap").show();
                };
                img.src = res;
            }
        };

        $(document).ready(function() {
            demo_h5_upload_ops.init();
        });

        $("#reCamera").click(function(event) {
            $("#upload").click();
        });

        $("#div1").click(function(event) {
            $("#upload").click();
        });

        $("#reUploading").on("click", function() {
            var attr = $(this).attr("state");
            if (attr == "0") {
                alert('请不要重复提交！');
                return false;
            }
            uploadShopListImg(uid, mobile, dataUrl,cityid);
        });

        function uploadShopListImg(uid, mobile, dataUrl,cityid) {
            var tmp = {
                "uid": uid,
                "mobile": mobile,
                "dataUrl": dataUrl,
                "cityId": cityid
            };
            var sendData = createSign(tmp);
            $.ajax({
                url: COUPON_URL + "Home/Requestajax/uploadShopListImg",
                type: 'POST',
                dataType: 'json',
                async: false,
                data: sendData,
                beforeSend: function() {
                    $("#reUploading").attr("state", "0");
                },
                success: function(data) {
                    console.log(data)
                    if (data.state == 0) {
                        tishi("上传成功");
                        window.location.reload();
                    }
                },
                error: function(data) {
                    console.log(data)
                }
            })
        }

        // 积分记录列表  getIntegralRecord  积分记录列表    参数uid
        function getIntegralRecord() {
            var tmp = {
                "uid": uid
            };
            var sendData = createSign(tmp);
            $.ajax({
                url: COUPON_URL + "Home/Requestajax/getIntegralRecord",
                type: 'POST',
                dataType: 'json',
                async: false,
                data: sendData,
                success: function(data) {
                    console.log(data);
                    var html = '';
                    if (data.result.length == 0) {
                        $(".norecord").show();
                        return false;
                    }
                    $.each(data.result, function(i, k) {
                        var font = '';
                        var className = '';
                        var des = '本次积分：' + k.point + '';
                        var dot = '';
                        var sh = '<p class="seedetails" id_=' + k.id + '>查看详情 〉〉</p>';
                        if (k.status == 0) {
                            font = "审核中";
                            className = "stateR";
                            // sh='';
                        } else if (k.status == 1) {
                            font = "已完成";
                            className = "stateG";
                        } else {
                            className = "stateR";
                            font = "审核失败";
                            if (k.description.length >= 14) {
                                dot = "...";
                            }
                            des = "失败原因：" + k.description + dot;
                        }
                        html += '<div class="recordList">' +
                            '<div>' +
                            '<p class="zpoint">自助积分 (' + k.addtime + ')</p>' +
                            '<p class="state ' + className + '">' + font + '</p>' +
                            '</div>' +
                            '<div>' +
                            '<p class="needpoint">' + des + '</p>' +
                            sh +
                            '</div>' +
                            '</div>';
                    });
                    $(".recordBox").html(html);
                }
            })
        }
        getIntegralRecord();
        $(".seedetails").on("click", function() {
            var id_ = $(this).attr("id_");
            window.location.href = WX_URL + "user.php?selfhelpdetails=1&id=" + id_;
        })

        goHomeBtn("body");

        var appId = '<?php echo APPID?>';
        var nonceStr = '<?php echo $nonceStr;?>';
        var timestamp = '<?php echo $timestamp;?>';
        var signature = '<?php echo $signature;?>';
        // 微信分享
        wx.config({
            debug: false,
            appId: appId,
            timestamp: timestamp,
            nonceStr: nonceStr,
            signature: signature,
            jsApiList: ['checkJsApi', 'onMenuShareAppMessage']
        });
        wx.ready(function() {
            wx.checkJsApi({
                jsApiList: ['onMenuShareAppMessage'],
                success: function(res) {
                    console.log(res);
                }
            });
            wx.onMenuShareAppMessage({
                title: '吃喝玩乐 华熙LIVE一卡通', // 分享标题
                desc: '花钱有积分，积分当钱花！', // 分享描述
                link: WX_URL + 'user.php?uploading', // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                imgUrl: WX_URL + 'tmp/title.png', // 分享图标
                type: '', // 分享类型,music、video或link，不填默认为link
                dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
                success: function() {
                    // 用户确认分享后执行的回调函数
                    console.log("分享成功");
                },
                cancel: function() {
                    // 用户取消分享后执行的回调函数
                    console.log("取消分享");
                }
            });
        });
        wx.error(function(res) {
            // console.log(res);
        });
    </script>
</body>

</html>
