<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="format-detection" content="telephone=no" />
    <meta name="format-detection" content="email=no" />
    <title>填写订单</title>
    <link rel="stylesheet" href="weixin/schedule/css/choose_session_price_num.css">
    <link rel="stylesheet" type="text/css" href="weixin/schedule/css/peisong.css" />
    <link rel="stylesheet" href="weixin/schedule/css/common.css">
    <style>
        .choose_seesion_time {
            width: auto !important;
            padding-left: 0.1rem;
            padding-right: 0.1rem;
        }

        .shezhi_tishinew {
            width: 3rem;
            border-radius: 0.04rem;
            background: #000000;
            opacity: 0.7;
            position: fixed;
            padding: 0.07rem 0.14rem;
            left: 0px;
            top: 30%;
            color: #FFFFFF;
            text-align: center;
            display: none;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <header class="header bor_bottom">
            <p class="time_name">
                <?php echo $lockInfo['showtitle']?>
            </p>
            <p class="time_session">场次：
                <?php echo $lockInfo['playtime']?>
            </p>
        </header>
        <div class="choose choose_seesion">
            <div class="title_price">
                <p class="choose_title font_14_color_128">数量：<span class="font_18_color_233" id="ticketNum"><?php echo $lockInfo['ticketCount']?></span> 张</p>
                <p class="choose_price font_14_color_128"><span class="font_18_color_233"><?php echo $lockInfo['payAmount']?></span> 元</p>
            </div>
            <div class="choose_seesion_centen choose_seesion_price_box">
                <!--<?php foreach($lockInfo['seatIds'] as $v) {?>
                <div class="choose_seesion_time">
                    <?php echo $v['scheduleAreaName'],$v['lineName'],$v['rankName']?>
                </div>
                <?php }?>-->
            </div>
        </div>

        <div class="peisongxinxi">
            <div class="peisongxinxi_type bor_bottom">
                <p class="font_15_color_51">配送方式：<span><?php echo $lockInfo['ticketType']?'电子票':'快递'?></span></p>
            </div>
            <div class="peisongxinxi_mobile">
                <p class="font_15_color_51">购票人手机号：</p><input type="number" name="buyerNumber" id="buyerNumber" value="<?php echo $mobile?>" placeholder="用于接收取票码等相关信息" readonly="readonly" />
            </div>
        </div>
        <?php if(!$lockInfo['ticketType']) {?>
        <?php if(empty($defaultAddress)) {?>
        <!--添加收货地址-->
        <div class="tianjiashouhuodizhi chooseaddress">
            <img src="weixin/schedule/pic/icon_add.png" class="icon_add" />
            <p class="font_15_color_51">请添加收货地址</p>
            <img src="weixin/schedule/pic/gengduo.png" class="xiangyoujianhao" />
        </div>
        <?php } else {?>
        <!--收货地址列表-->
        <div class="dizhi_liebiao chooseaddress" aid="<?php echo $defaultAddress['id']?>">
            <div class="xingmingshoujihao">
                <p class="font_15_color_51 xingmingshoujihao_p1" id="receiverName">
                    <?php echo $defaultAddress['name']?>
                </p>
                <p class="font_15_color_51 xingmingshoujihao_p2" id="receiverMobile">
                    <?php echo $defaultAddress['mobile']?>
                </p>
            </div>
            <div class="xiangxidizhi">
                <p class="font_14_color_128" id="receiverAddress">
                    <?php echo $defaultAddress['address']?>
                </p>
            </div>
            <div class="jianhao">
                <img src="weixin/schedule/pic/gengduo.png" />
            </div>
        </div>
        <?php }?>
        <?php }?>

        <?php if ($lockInfo['realNameStatus'] != 0) {?>
        <div class="shenfenzheng_liebiao">
            <div class="shenfenzhengliebiao_tishi bor_bottom">
                <div class="touxiang">
                    <img src="weixin/schedule/pic/icon_tx.png" />
                </div>
                <p class="font_14_color_128"><span class="font_15_color_233">本项目为实名购票，请携带您输入的实名信息证件入场</span><br/><span class="shenfenzhengliebiao_tishi_span">一张票需要一个实名制信息，提交后不可修改，请谨慎输入</span></p>
            </div>
            <?php if (!empty($peiSongRealNameList)) {?>
            <?php foreach ($peiSongRealNameList as $v) {?>
            <div class="system_information_list" cid="<?php echo $v['id']?>">
                <p class="name_name">
                    <?php echo $v['name']?>
                </p>
                <p><span class="cardName"><?php echo $v['cardName']?>：</span><span class="shenfenzhenghao"><?php echo $v['idCard']?></span></p>
                <p style="display:none;"><span class="cardType"><?php echo $v['cardType']?></span></p>
                <div class="removeBtn" cid="<?php echo $v['id']?>">
                    <img src="weixin/schedule/pic/icon_delete.png" />
                </div>
            </div>
            <?php }?>
            <?php }?>
            <div class="tianjiaBtn">
                <img src="weixin/schedule/pic/icon_addsm.png" />
                <p class="font_15_color_51">添加实名制信息</p>
            </div>
        </div>
        <?php }?>
        <div class="footer">下一步</div>
    </div>
    <div class="shezhi_tishi" style="display:none">
        <P>设置成功</P>
    </div>
    <div class="shezhi_tishinew" style="display:none">
        <P>设置成功</P>
    </div>
    <script src="weixin/common/zepto.min.js"></script>
    <script src="weixin/common/jquery.js"></script>
    <script src="weixin/common/fontSize.js"></script>
    <script src="weixin/common/common.js"></script>
    <script type="text/javascript" src="https://pingjs.qq.com/h5/stats.js" name="MTAH5" sid="500338441"></script>
    <script>
        var qeuhuo = '<span class="quehuodengji">缺货登记</span>';
        var uid = "<?php echo $uid?>";
        var orderNo = "<?php echo $orderNo?>";
        // var ticketType = "<?php echo $lockInfo['ticketType']?>";
        var ticketType = 0;
        var realNameStatus = "<?php echo $lockInfo['realNameStatus']?>";

        $(".chooseaddress").on("click", function() { //添加收货地址
            var cids = [];
            $(".system_information_list").each(function(index, el) {
                cids.push($(el).attr('cid'));
            });
            location.href = WX_URL + "user.php?addressList=1&chooseAddress=yes&orderNo=" + orderNo + "&cids=" + cids;
        })
        $(".tianjiaBtn").click(function(event) { //添加实名制信息
            if ($(".dizhi_liebiao").attr('aid') == undefined) {
                var aid = '';
            } else {
                var aid = $(".dizhi_liebiao").attr('aid');
            }
            location.href = WX_URL + "user.php?realNameList=1&chooseRealName=yes&orderNo=" + orderNo + "&aid=" + aid;
        });

        $(".footer").click(function(event) {
            var buyerNumber = $("#buyerNumber").val().trim();
            var receiverName, receiverMobile, receiverAddress;
            if (ticketType == 0) {
                receiverName = "<?php echo $defaultAddress['name']?>";
                receiverMobile = "<?php echo $defaultAddress['mobile']?>";
                receiverAddress = "<?php echo $defaultAddress['address']?>";
            }
            var ticketNum = <?php echo $lockInfo['ticketCount']?>;
            var viewers = new Array();

            if (realNameStatus != 0) {
                var shenfenzhenghao = $(".shenfenzhenghao");
                var name_name = $(".name_name");
                var cardNames = $(".cardName");
                var cardTypes = $(".cardType");

                for (var i in shenfenzhenghao) {
                    var id = shenfenzhenghao[i].innerHTML;
                    var name = name_name[i].innerHTML;
                    var cardName = cardNames[i].innerHTML;
                    var cardType = cardTypes[i].innerHTML;
                    if (name == undefined && id == undefined) {
                        break;
                    }
                    viewers.push(new ObjStory(name, id, cardName, cardType));
                }
                if (viewers.length == 0) {
                    tishi("请添加实名制信息！");
                    return;
                }
                if (viewers.length != ticketNum) {
                    tishi("您购买了" + ticketNum + '张票' + ',需要' + ticketNum + '个实名信息！');
                    return;
                }
            }

            if (!(/^(((13[0-9]{1})|(15[0-9]{1})|(18[0-9]{1}))+\d{8})$/.test(buyerNumber))) {
                tishi("***请输入11位手机号***");
                return false;
            }

            var data = {
                'uid': uid,
                'orderNo': orderNo,
                'owner': 'hxxc',
                'buyerNumber': buyerNumber,
                'ticketType': ticketType,
                'receiverMobile': receiverMobile,
                'receiverAddress': receiverAddress,
                'receiverName': receiverName,
                'viewers': viewers,
                'ticketNum': ticketNum,
                'identity': 'placeOrder'
            };
            $.ajax({
                    url: WX_URL + 'requestAjax.php',
                    type: 'POST',
                    dataType: 'json',
                    data: data,
                })
                .done(function(res) {
                    if (res.state == 1) {

                        tishinew(res.message.trim());

                        return false;
                    } else if (res == -1) {
                        tishi('未知错误，请稍后再试！');
                        return false;
                    } else {
                        location.href = WX_URL + "user.php?orderData=" + JSON.stringify(res);
                        return false;
                    }
                })
                .fail(function(res) {
                    return;
                });
        });
        $(".removeBtn").click(function(event) {
            $(this).parent().remove();
        });
    </script>
</body>

</html>
