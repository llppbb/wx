<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="format-detection" content="telephone=no" />
    <meta name="format-detection" content="email=no" />
    <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" id="viewport" name="viewport">
    <title>选择</title>
    <link rel="stylesheet" href="weixin/schedule/css/choose_session_price_num.css">
</head>

<body>
    <div class="wrap">
        <header class="header">
            <p class="time_name">
                <?php echo $schedulePriceInfo['showtitle']?>
            </p>
        </header>
        <div class="choose choose_seesion">
            <p class="choose_title">选择场次</p>
            <div class="choose_seesion_centen choose_seesion_price_box">
                <?php foreach ($schedulePriceInfo['schedule'] as $v) {?>
                <div class="choose_seesion_time" scheduleid="<?php echo $v['id']?>" buyLimit="<?php echo $v['scheduleNumber']?>">
                    <?php echo $v['playTime']?>
                </div>
                <?php }?>
            </div>
        </div>
        <div class="choose choose_price">
            <p class="choose_title">选择票价</p>
            <?php foreach ($schedulePriceInfo['schedule'] as $v) {?>
            <div class="choose_seesion_centen pricearea choose_seesion_price_box" id="sp_<?php echo $v['id']?>">
                <?php foreach ($v['ticketPrice'] as $v1) {?>
                <div class="choose_seesion_price <?php echo ($v1['status'] == 3 || $v1['ticketCount'] == 0)?'choose_seesion_NOprice':''?>" ticketPriceId="<?php echo $v1['id']?>" price="<?php echo $v1['price']?>" ticketCount="<?php echo $v1['ticketCount']?>">
                    <?php echo $v1['price']?>元
                    <?php echo empty($v1['description'])?'':'（'.$v1['description'].'）'?>
                </div>
                <?php }?>
                <?php foreach ($v['packTickets'] as $v2) {?>
                <div class="choose_seesion_price <?php echo ($v2['status'] == 3 || $v2['ticketCount'] == 0)?'choose_seesion_NOprice':''?>" packTicketId="<?php echo $v2['id']?>" ticketPriceId="<?php echo $v2['ticketPriceId']?>" price="<?php echo $v2['packAmount']?>" ticketCount="<?php echo $v2['ticketCount']?>">
                    <?php echo $v2['name']?>
                </div>
                <?php }?>
            </div>
            <?php }?>
        </div>
        <div class="choose choose_num">
            <p class="choose_title">选择张数<span class="choose_num_span">同一账号同一场次一次限购<span id="buyLimit">2</span>张</span>
            </p>
            <div class="choose_seesion_centen choose_seesion_centen_jisuan">
                <div class="choose_seesion_jisuan choose_seesion_jian choose_seesion_border" id="removeBtn">
                    <p>﹣</p>
                </div>
                <div class="choose_seesion_jisuan choose_seesion_number">1</div>
                <div class="choose_seesion_jisuan choose_seesion_add" id="addBtn">﹢</div>
                <div class="allprice">
                    <p>总价</p>
                    <P><span id="price">0</span><span>元</span></P>
                </div>
            </div>
        </div>
        <div class="footerNext">
            <p>下一步</p>
        </div>
    </div>
    <div class="mengceng"></div>
    <!--<div class="dengluchenggong_tishi">登陆成功！</div>-->
    <div class="weidenglu_tishi" id="hasmobile">
        <div class="weidenglu_tishi_title">
            <p class="weidenglu_tishi_title_p1">缺货登记</p>
        </div>
        <div class="weidenglu_tishi_title">
            <p class="weidenglu_tishi_title_p2">本售价已售罄，点击确定按钮，我们将在有票时第一时间将短信通知发送给您的手机</p>
        </div>
        <div class="weidenglu_tishi_mobile">
            <p>
                <?php echo $showMobile?>
            </p>
        </div>
        <div class="weidenglu_tishi_bottom">
            <div class="quexiaoBtn">取消</div>
            <div class="quedingBtn">确定</div>
        </div>
    </div>
    <div class="weidenglu_tishi" id="nomobile">
        <div class="weidenglu_tishi_title">
            <p class="weidenglu_tishi_title_p1">缺货登记</p>
        </div>
        <div class="yangzhengChange">
            <div class="shoujihao">
                <input type="number" placeholder="请输入手机号" id="shoujihao" class="numberShoujihao" />
                <input type="button" class="getyzm" value="获取验证码" />
            </div>
            <div class="yanzhengma">
                <input type="number" placeholder="4位验证码" id="yanzhengmaBtn" class="yazhengmaIput" />
            </div>
        </div>
        <div class="weidenglu_tishi_title">
            <p class="weidenglu_tishi_title_p2">本售价已售罄，点击确定按钮，我们将在有票时第一时间将短信通知发送给您的手机</p>
        </div>
        <div class="weidenglu_tishi_bottom">
            <div class="quexiaoBtn">取消</div>
            <div class="quedingBtn">确定</div>
        </div>
    </div>
    <div class="shezhi_tishi" style="display: none">
        <P>设置成功</P>
    </div>
    <!--有未支付订单提示-->
    <div class="yidenglu_tihsi weizhifudingdan_tihsi" style="display: none;">
        <div class="yidenglu_tihsi_title">
            <p class="yidenglu_tihsi_title_p2 weizhifudingdan_tihsi_title_p2">
                <span id="buyLimit_tihsi">该场次限购x张，</span>检测到您还有未支付订单，故无法重复购买，你可以前往继续支付或取消订单
            </p>
        </div>
        <div class="yidenglu_tihsi_bottom">
            <div class="quexiaoBtn">取消</div>
            <div id="ViewUnpaidOrders">查看未支付订单</div>
        </div>
    </div>
    <script src="weixin/common/jquery.js"></script>
    <script src="weixin/common/fontSize.js"></script>
    <script src="weixin/schedule/js/Judge_state.js"></script>
    <script src="weixin/common/common.js"></script>
    <script type="text/javascript" src="https://pingjs.qq.com/h5/stats.js" name="MTAH5" sid="500338441"></script>
    <script>
        var uid = "<?php echo $uid?>";
        var mobile = "<?php echo $mobile?>";
        var onlineID = "<?php echo $onlineID?>";
        var tishiBox = '';

        window.onload = function() {
            // var classNeme = $('.choose_seesion_time');
            // Judge_state(classNeme);
            $('.choose_seesion_time:first').addClass('choose_seesion_time_on');
            $('.choose_seesion_price:first').addClass('choose_seesion_price_on');
            $('.pricearea:first').show();
            var price = $(".choose_seesion_price_on").attr('price');
            var ticketNum = $(".choose_seesion_number").html();
            var total = (ticketNum * price).toFixed(2);
            $("#price").html(total);
            var buyLimit = $(".choose_seesion_time_on").attr('buyLimit');
            if (buyLimit != 0) {
                $("#buyLimit").html(buyLimit);
            } else {
                $(".choose_num_span").hide();
            }
        }

        var quehuo = '<p class="quehuodengji">缺货登记</p>';

        $(".choose_seesion_NOprice").append(quehuo);

        $("#removeBtn").on("click", function() {
            var buyLimit = $(".choose_seesion_time_on").attr('buyLimit');
            var value = $(".choose_seesion_number").html();
            var newvalue = --value;

            if (newvalue < buyLimit && newvalue > 1) {
                $("#addBtn").css({
                    'color': '#333333',
                    'border': '1px solid #333333'
                });
            } else if (newvalue <= 1) {
                newvalue = 1;
                $(".choose_seesion_jian p").css({
                    'color': '#E6E6E6'
                });
                $(".choose_seesion_border").css({
                    'border': '1px solid #E6E6E6'
                });
                $("#addBtn").css({
                    'color': '#333333',
                    'border': '1px solid #333333'
                });
            }
            $(".choose_seesion_number").html(newvalue);
            var price = $(".choose_seesion_price_on").attr('price');
            var ticketNum = $(".choose_seesion_number").html();
            var total = (ticketNum * price).toFixed(2);
            $("#price").html(total);
        });

        $("#addBtn").on("click", function() {
            var buyLimit = $(".choose_seesion_time_on").attr('buyLimit');
            var price = $(".choose_seesion_price_on").attr('price');
            var ticketCount = $(".choose_seesion_price_on").attr('ticketCount');
            var value = $(".choose_seesion_number").html();

            if (price == undefined) {
                tishi('请选择价格');
                return false;
            }

            var newvalue = ++value;
            if (buyLimit != 0) {
                if (newvalue > 1) {
                    $(".choose_seesion_jian p").css({
                        'color': '#333333'
                    });
                    $(".choose_seesion_border").css({
                        'border': '1px solid #333333'
                    });
                    if (newvalue == ticketCount) {
                        $("#addBtn").css({
                            'color': '#E6E6E6',
                            'border': '1px solid #E6E6E6'
                        });
                    } else if (newvalue > ticketCount) {
                        $("#addBtn").css({
                            'color': '#E6E6E6',
                            'border': '1px solid #E6E6E6'
                        });
                        tishi('余票不足！');
                        return false;
                    } else if (newvalue == buyLimit) {
                        $("#addBtn").css({
                            'color': '#E6E6E6',
                            'border': '1px solid #E6E6E6'
                        });
                    } else if (newvalue > buyLimit) {
                        $("#addBtn").css({
                            'color': '#E6E6E6',
                            'border': '1px solid #E6E6E6'
                        });
                        tishi('该场次限购' + buyLimit + '张票！');
                        return false;
                    }
                }
            } else {
                if (newvalue > 1) {
                    $(".choose_seesion_jian p").css({
                        'color': '#333333'
                    });
                    $(".choose_seesion_border").css({
                        'border': '1px solid #333333'
                    });
                    if (newvalue == ticketCount) {
                        $("#addBtn").css({
                            'color': '#E6E6E6',
                            'border': '1px solid #E6E6E6'
                        });
                    } else if (newvalue > ticketCount) {
                        tishi('余票不足！');
                        return false;
                    }
                }
            }

            $(".choose_seesion_number").html(newvalue);

            var ticketNum = $(".choose_seesion_number").html();
            var total = (ticketNum * price).toFixed(2);
            $("#price").html(total);

            return false;
        });

        $(".choose_seesion_time").click(function(event) {
            $("#addBtn").css({
                'color': '#333333'
            });
            $("#addBtn").css({
                'border': '1px solid #333333'
            });
            $(".choose_seesion_jian p").css({
                'color': '#E6E6E6'
            });
            $(".choose_seesion_border").css({
                'border': '1px solid #E6E6E6'
            });

            var scheduleid = $(this).attr('scheduleid');
            var buyLimit = $(this).attr('buyLimit'); //
            if (buyLimit != 0) {
                $(".choose_num_span").show();
            } else {
                $(".choose_num_span").hide();
            }
            $("#buyLimit").html(buyLimit); //
            $(this).addClass('choose_seesion_time_on').siblings().removeClass('choose_seesion_time_on');
            $(".choose_seesion_price").removeClass('choose_seesion_price_on');
            $(".choose_seesion_number").html(1);
            $("#price").html(0);
            $('.pricearea').hide();
            $('#sp_' + scheduleid).show();

            $('#sp_' + scheduleid).find('.choose_seesion_price:first').addClass('choose_seesion_price_on'); //
            var price = $(".choose_seesion_price_on").attr('price');
            var ticketNum = $(".choose_seesion_number").html();
            var total = (ticketNum * price).toFixed(2);
            $("#price").html(total);
        });
        $(".choose_seesion_price").click(function(event) {
            $("#addBtn").css({
                'color': '#333333'
            });
            $("#addBtn").css({
                'border': '1px solid #333333'
            });
            $(".choose_seesion_jian p").css({
                'color': '#E6E6E6'
            });
            $(".choose_seesion_border").css({
                'border': '1px solid #E6E6E6'
            });

            $(".choose_seesion_price").removeClass('choose_seesion_price_on');
            $(this).addClass('choose_seesion_price_on');

            $(".choose_seesion_number").html(1);
            var price = $(".choose_seesion_price_on").attr('price');
            var ticketNum = $(".choose_seesion_number").html();
            var total = (ticketNum * price).toFixed(2);
            $("#price").html(total);
        });
        $(".choose_seesion_NOprice").click(function(event) { //缺货提示
            $(".mengceng").show();
            if (mobile != 0) {
                tishiBox = $("#hasmobile");
                tishiBox.show();
            } else {
                tishiBox = $("#nomobile");
                tishiBox.show();
                return;
            }
        });
        $(".quexiaoBtn").click(function(event) {
            $(".mengceng").hide();
            tishiBox.hide();
            return;
        });
        $("#ViewUnpaidOrders").click(function(event) {
            tishiBox.hide();
            location.href = WX_URL + "user.php?cbaOrderList=1";
            return;
        });
        $(".quedingBtn").click(function(event) {
            var scheduleId = $(".choose_seesion_time_on").attr("scheduleid");
            var ticketPriceId = $(".choose_seesion_price_on").attr('ticketPriceId');
            var packTicketId = $(".choose_seesion_price_on").attr('packTicketId') ? $(".choose_seesion_price_on").attr('packTicketId') : '';
            if (mobile != 0) {
                $(".mengceng").hide();
                ShortageRegistration(uid, mobile, onlineID, scheduleId, ticketPriceId, packTicketId, tishiBox);
            } else {
                var shoujihao = $("#shoujihao").val();
                var yanzhengma = $("#yanzhengmaBtn").val();
                var checkResult = checkMobileAndSMSCode(shoujihao, yanzhengma);
                if (!checkResult) {
                    return false;
                }
                // 2.绑定手机
                var bindMobileInfo = bindMobile(uid, shoujihao, yanzhengma);
                if (bindMobileInfo.state != 0) {
                    tishi(bindMobileInfo.message);
                } else {
                    // 3.缺货登记
                    $(".mengceng").hide();
                    ShortageRegistration(uid, shoujihao, onlineID, scheduleId, ticketPriceId, packTicketId, tishiBox);
                }
            }
        });
        // 1.获取验证码
        $(".getyzm").click(function(event) {
            var mobile = $("#shoujihao").val();
            var obj = $(".getyzm");
            getyzm(mobile, obj);
        });

        $(".footerNext").click(function(event) {
            var scheduleid = $(".choose_seesion_time_on").attr('scheduleid');
            var ticketPriceId = $(".choose_seesion_price_on").attr('ticketPriceId');
            var packTicketId = $(".choose_seesion_price_on").attr('packTicketId') ? $(".choose_seesion_price_on").attr('packTicketId') : '';
            var ticketNum = $(".choose_seesion_number").html();

            if (scheduleid == undefined || ticketPriceId == undefined || $(".choose_seesion_price_on").hasClass('choose_seesion_NOprice')) {
                tishi("请选择场次或价格！");
                return false;
            }

            $.ajax({
                    url: WX_URL + "requestAjax.php",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        "uid": uid,
                        "onlineID": onlineID,
                        "scheduleId": scheduleid,
                        "ticketPriceId": ticketPriceId,
                        'packTicketId': packTicketId,
                        "ticketNum": ticketNum,
                        "identity": 'lockSeat'
                    }
                })
                .done(function(res) {
                    if (res.state == 1) {
                        if (res.message.indexOf('未支付') != -1) {
                            tishiBox = $('.weizhifudingdan_tihsi');
                            $(".mengceng").show();
                            var buyLimit = $(".choose_seesion_time_on").attr('buyLimit');
                            if (buyLimit > 0) {
                                $("#buyLimit_tihsi").text("该场次限购" + buyLimit + "张");
                            } else {
                                $("#buyLimit_tihsi").text('');
                            }
                            tishiBox.show();
                        } else {
                            tishi(res.message);
                        }
                        return;
                    } else if (res == -1) {
                        tishi("订单创建失败，请重新操作！");
                        return;
                    } else {
                        location.href = WX_URL + "user.php?placeOrder=1&orderNo=" + res.orderNo;
                    }
                });
        });
    </script>
</body>

</html>
